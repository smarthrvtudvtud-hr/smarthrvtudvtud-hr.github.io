<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/100/face-id.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/face-id.png">
    <title>ระบบลงเวลาทำงาน</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1e293b;
            --bg-card: #151c2c;
            --bg-elevated: #1e2a3a;
            --border: rgba(99, 115, 148, 0.2);
            --border-light: rgba(99, 115, 148, 0.35);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #10b981;
            --accent-green-dark: #059669;
            --accent-green-bg: rgba(16, 185, 129, 0.12);
            --accent-green-glow: rgba(16, 185, 129, 0.4);
            --accent-blue: #3b82f6;
            --accent-blue-light: #60a5fa;
            --accent-blue-dark: #2563eb;
            --accent-blue-bg: rgba(59, 130, 246, 0.12);
            --accent-blue-glow: rgba(59, 130, 246, 0.4);
            --accent-purple: #8b5cf6;
            --accent-purple-bg: rgba(139, 92, 246, 0.12);
            --accent-yellow: #f59e0b;
            --accent-yellow-bg: rgba(245, 158, 11, 0.12);
            --accent-red: #ef4444;
            --accent-red-dark: #dc2626;
            --accent-red-bg: rgba(239, 68, 68, 0.12);
            --accent-red-glow: rgba(239, 68, 68, 0.4);
            --accent-cyan: #06b6d4;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --shadow-xl: 0 16px 48px rgba(0,0,0,0.6);
            --shadow-glow-blue: 0 0 20px rgba(59,130,246,0.3);
            --shadow-glow-green: 0 0 20px rgba(16,185,129,0.3);
            --shadow-glow-red: 0 0 20px rgba(239,68,68,0.3);
            --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.3);
            --radius: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-xs: 6px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        html { font-size:16px; -webkit-text-size-adjust:100%; overflow-x:hidden; }
        body { font-family:'Kanit',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; min-height:100dvh; line-height:1.5; overflow-x:hidden; -webkit-font-smoothing:antialiased; width:100%; max-width:100vw; }
        .hidden { display:none !important; }
        @keyframes spin { to { transform:rotate(360deg); } }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
        .spinner { animation:spin 1s linear infinite; }
        .loading-overlay { position:fixed; inset:0; background:linear-gradient(135deg,var(--bg-primary) 0%,var(--bg-secondary) 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        .loader-ring { width:56px; height:56px; border:3px solid var(--border); border-radius:50%; border-top-color:var(--accent-blue); animation:spin 1s ease-in-out infinite; margin-bottom:24px; box-shadow:var(--shadow-glow-blue); }
        .loading-text { font-size:0.95rem; margin-bottom:20px; color:var(--text-secondary); }
        .progress-bar { width:200px; height:4px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--accent-blue),var(--accent-cyan)); border-radius:4px; transition:width 0.4s ease; }
        .page { display:none; min-height:100vh; min-height:100dvh; background:var(--bg-primary); padding-top:var(--safe-top); width:100%; max-width:100vw; overflow-x:hidden; }
        .page.active { display:flex; flex-direction:column; animation:fadeIn 0.3s ease; }
        .att-page { background:linear-gradient(180deg,var(--bg-secondary) 0%,var(--bg-primary) 50%); }
        .att-container { width:100%; max-width:440px; margin:0 auto; padding:0 16px; padding-bottom:calc(24px + var(--safe-bottom)); flex:1; padding-top:100px; }
        .att-header { display:flex; justify-content:space-between; align-items:center; padding:16px; position:fixed; top:0; left:0; right:0; z-index:500; background:var(--bg-primary); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border-bottom:1px solid var(--border); }
        @supports (padding-top: env(safe-area-inset-top)) {
            .att-header { padding-top:calc(16px + env(safe-area-inset-top,0px)); }
            .att-container { padding-top:calc(100px + env(safe-area-inset-top,0px)); }
        }
        @media all and (display-mode: standalone) {
            .att-header { padding-top:calc(8px + var(--safe-top)) !important; }
            .att-container { padding-top:calc(60px + var(--safe-top)) !important; }
            .admin-header { padding-top:calc(8px + var(--safe-top)) !important; }
            .admin-page .admin-container { padding-top:calc(40px + var(--safe-top)) !important; }
            .sidebar { padding-top:calc(8px + var(--safe-top)) !important; }
        }
        @media all and (display-mode: standalone) and (min-width:601px) {
            .att-container { padding-top:calc(85px + var(--safe-top)) !important; }
            .admin-page .admin-container { padding-top:calc(85px + var(--safe-top)) !important; }
        }
        html.pwa-standalone .att-header { padding-top:calc(8px + var(--safe-top)) !important; }
        html.pwa-standalone .att-container { padding-top:calc(60px + var(--safe-top)) !important; }
        html.pwa-standalone .admin-header { padding-top:calc(8px + var(--safe-top)) !important; }
        html.pwa-standalone .admin-page .admin-container { padding-top:calc(40px + var(--safe-top)) !important; }
        @media (min-width:601px) {
            html.pwa-standalone .att-container { padding-top:calc(85px + var(--safe-top)) !important; }
            html.pwa-standalone .admin-page .admin-container { padding-top:calc(85px + var(--safe-top)) !important; }
        }
        .att-logo { display:flex; align-items:center; gap:12px; }
        .att-logo .icon { width:46px; height:46px; background:linear-gradient(135deg,var(--accent-blue-bg) 0%,var(--accent-purple-bg) 100%); border-radius:var(--radius-md); display:flex; align-items:center; justify-content:center; border:1px solid var(--border); box-shadow:var(--shadow-sm); }
        .att-logo [data-lucide] { width:24px; height:24px; color:var(--accent-blue-light); }
        .att-logo h1 { font-size:1.15rem; font-weight:600; background:linear-gradient(135deg,var(--text-primary) 0%,var(--text-secondary) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .login-btn { background:var(--bg-tertiary); border:1px solid var(--border); color:var(--text-primary); padding:10px 18px; border-radius:var(--radius-sm); font-family:'Kanit'; font-size:0.85rem; font-weight:500; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all 0.3s ease; box-shadow:var(--shadow-sm); }
        .login-btn:hover { background:var(--bg-elevated); border-color:var(--accent-blue); transform:translateY(-2px); box-shadow:var(--shadow-md),var(--shadow-glow-blue); }
        .login-btn [data-lucide] { width:16px; height:16px; color:var(--accent-blue); }
        .main-card { background:var(--bg-card); border-radius:var(--radius); box-shadow:var(--shadow-lg); overflow:hidden; border:1px solid var(--border); margin-top:16px; animation:slideUp 0.4s ease; }
        .time-section { padding:32px 24px; text-align:center; background:linear-gradient(180deg,var(--bg-elevated) 0%,var(--bg-card) 100%); border-bottom:1px solid var(--border); position:relative; overflow:hidden; }
        .time-display { font-size:clamp(2.8rem,12vw,3.8rem); font-weight:700; color:var(--text-primary); line-height:1; margin-bottom:8px; font-variant-numeric:tabular-nums; text-shadow:0 2px 10px rgba(0,0,0,0.3); }
        .date-display { font-size:0.9rem; color:var(--text-secondary); }
        .status-section { padding:16px 20px; }
        .status-card { padding:14px 16px; border-radius:var(--radius-sm); display:flex; align-items:center; gap:12px; background:var(--accent-blue-bg); border:1px solid rgba(59,130,246,0.3); transition:all 0.3s ease; }
        .status-card.matched { background:var(--accent-green-bg); border-color:rgba(16,185,129,0.3); box-shadow:var(--shadow-glow-green); }
        .status-card [data-lucide] { width:22px; height:22px; color:var(--accent-blue); }
        .status-card.matched [data-lucide] { color:var(--accent-green); }
        .status-card span { font-size:0.9rem; font-weight:500; }
        .shift-section { padding:20px; }
        .section-label { font-size:0.85rem; font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px; color:var(--text-secondary); }
        .section-label [data-lucide] { width:16px; height:16px; color:var(--accent-blue); }
        .section-label .btn-icon { background:var(--bg-tertiary); color:var(--text-secondary); border:1px solid var(--border); width:36px !important; height:36px !important; min-width:36px !important; }
        .section-label .btn-icon:hover { background:var(--accent-blue-bg); color:var(--accent-blue); border-color:var(--accent-blue); }
        .section-label .btn-icon [data-lucide] { color:inherit; }
        .shift-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
        .shift-btn { padding:14px 8px; border:2px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-tertiary); cursor:pointer; text-align:center; font-family:'Kanit'; transition:all 0.3s ease; box-shadow:var(--shadow-sm); }
        .shift-btn:hover { border-color:var(--accent-blue); background:var(--bg-elevated); transform:translateY(-2px); box-shadow:var(--shadow-md); }
        .shift-btn.active { border-color:var(--accent-green); background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); box-shadow:var(--shadow-glow-green); transform:translateY(-2px); }
        .shift-btn .name { font-weight:600; font-size:0.85rem; color:var(--text-primary); }
        .shift-btn .time { font-size:0.7rem; color:var(--text-secondary); margin-top:2px; }
        .shift-btn.active .name,.shift-btn.active .time { color:white; }
        .camera-section { padding:0 20px 20px; }
        .camera-wrapper { position:relative; aspect-ratio:4/3; background:linear-gradient(135deg,#000 0%,#0a0f1a 100%); border-radius:var(--radius-md); overflow:hidden; border:2px solid var(--border); box-shadow:var(--shadow-inner),var(--shadow-md); }
        .camera-wrapper video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
        .camera-wrapper canvas { position:absolute; inset:0; width:100%; height:100%; transform:scaleX(-1); }
        .camera-placeholder { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); background:linear-gradient(135deg,var(--bg-tertiary) 0%,var(--bg-primary) 100%); }
        .camera-placeholder [data-lucide] { width:48px; height:48px; margin-bottom:12px; opacity:0.5; }
        .matched-section { padding:16px 20px; border-top:1px solid var(--border); display:flex; align-items:center; gap:14px; background:linear-gradient(135deg,var(--accent-green-bg) 0%,transparent 100%); animation:fadeIn 0.3s ease; }
        .matched-avatar { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.3rem; font-weight:700; box-shadow:var(--shadow-md),var(--shadow-glow-green); }
        .matched-info { flex:1; }
        .matched-info h3 { font-size:1rem; font-weight:600; }
        .matched-info p { font-size:0.75rem; color:var(--text-secondary); }
        .confidence-badge { text-align:center; padding:8px 14px; background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); border-radius:var(--radius-sm); color:white; box-shadow:var(--shadow-sm); }
        .confidence-badge .value { font-size:1.15rem; font-weight:700; }
        .confidence-badge .label { font-size:0.6rem; opacity:0.9; }
        .action-inner { padding:20px; display:flex; flex-direction:column; gap:12px; border-top:1px solid var(--border); background:var(--bg-tertiary); }
        .action-btn { padding:16px; border:none; border-radius:var(--radius-sm); font-family:'Kanit'; font-size:1.05rem; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; color:white; transition:all 0.3s ease; }
        .action-btn [data-lucide] { width:22px; height:22px; }
        .action-btn.checkin { background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); box-shadow:var(--shadow-md); }
        .action-btn.checkout { background:linear-gradient(135deg,var(--accent-red) 0%,var(--accent-red-dark) 100%); box-shadow:var(--shadow-md); }
        .action-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .action-btn:hover:not(:disabled) { transform:translateY(-3px); }
        .admin-page { background:var(--bg-primary); }
        .admin-header { background:var(--bg-primary); border-bottom:1px solid var(--border); padding:16px 20px; position:fixed; top:0; left:0; right:0; z-index:500; backdrop-filter:blur(12px); }
        .admin-page .admin-container { padding-top:95px; }
        @supports (padding-top: env(safe-area-inset-top)) {
            .admin-header { padding-top:calc(16px + env(safe-area-inset-top,0px)); }
            .admin-page .admin-container { padding-top:calc(95px + env(safe-area-inset-top,0px)); }
        }
        .admin-header-inner { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .admin-title { display:flex; align-items:center; gap:12px; }
        .admin-title [data-lucide] { width:24px; height:24px; color:var(--accent-blue); }
        .admin-title h1 { font-size:1.15rem; font-weight:600; }
        .avatar-btn { width:42px; height:42px; border-radius:50%; background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 100%); border:2px solid var(--border); color:white; font-weight:700; font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; font-family:'Kanit'; box-shadow:var(--shadow-sm); }
        .avatar-btn:hover { transform:scale(1.08); border-color:var(--accent-blue-light); box-shadow:var(--shadow-md),var(--shadow-glow-blue); }
        .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:998; opacity:0; visibility:hidden; transition:all 0.3s ease; }
        .sidebar-overlay.active { opacity:1; visibility:visible; }
        .sidebar { position:fixed; top:0; right:-300px; width:300px; max-width:85vw; height:100%; background:var(--bg-primary); border-left:1px solid var(--border); z-index:999; display:flex; flex-direction:column; padding-top:var(--safe-top); padding-bottom:var(--safe-bottom); box-shadow:var(--shadow-xl); transition:right 0.3s ease; }
        .sidebar.active { right:0; }
        .sidebar-header { padding:24px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:14px; background:var(--bg-primary); }
        .sidebar-avatar { width:54px; height:54px; border-radius:50%; background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.5rem; font-weight:700; box-shadow:var(--shadow-md); }
        .sidebar-user h3 { font-size:1rem; font-weight:600; }
        .sidebar-user p { font-size:0.75rem; color:var(--text-secondary); }
        .sidebar-nav { flex:1; padding:16px 12px; }
        .sidebar-nav-btn { width:100%; padding:14px 18px; border:none; background:transparent; color:var(--text-primary); font-family:'Kanit'; font-size:0.95rem; cursor:pointer; display:flex; align-items:center; gap:14px; transition:all 0.3s ease; text-align:left; border-radius:var(--radius-sm); margin-bottom:4px; }
        .sidebar-nav-btn:hover { background:var(--bg-tertiary); }
        .sidebar-nav-btn.active { background:var(--accent-blue-bg); color:var(--accent-blue); }
        .sidebar-nav-btn [data-lucide] { width:20px; height:20px; }
        .sidebar-nav-btn.logout { color:var(--accent-red); }
        .sidebar-nav-btn.logout:hover { background:var(--accent-red-bg); }
        .sidebar-close { position:absolute; top:calc(18px + var(--safe-top)); right:18px; width:34px; height:34px; border-radius:50%; background:var(--bg-tertiary); border:1px solid var(--border); color:var(--text-secondary); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; }
        .sidebar-close:hover { background:var(--accent-red-bg); border-color:var(--accent-red); color:var(--accent-red); transform:rotate(90deg); }
        .sidebar-close [data-lucide] { width:16px; height:16px; }
        .admin-container { max-width:1200px; margin:0 auto; padding:20px; padding-bottom:calc(24px + var(--safe-bottom)); flex:1; width:100%; }
        .tabs { background:var(--bg-card); border-radius:var(--radius-md); padding:6px; margin-bottom:20px; display:flex; gap:6px; box-shadow:var(--shadow-md); flex-wrap:wrap; border:1px solid var(--border); }
        .tab-btn { flex:1; min-width:100px; padding:12px 16px; border:none; background:transparent; border-radius:var(--radius-sm); font-family:'Kanit'; font-size:0.85rem; font-weight:500; color:var(--text-secondary); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s ease; }
        .tab-btn:hover { background:var(--bg-tertiary); color:var(--text-primary); }
        .tab-btn.active { background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-blue-dark) 100%); color:white; box-shadow:var(--shadow-sm),var(--shadow-glow-blue); }
        .tab-btn [data-lucide] { width:16px; height:16px; }
        .tab-content { display:none; animation:fadeIn 0.3s ease; }
        .tab-content.active { display:block; }
        .card { background:var(--bg-card); border-radius:var(--radius); box-shadow:var(--shadow-md); overflow:hidden; margin-bottom:20px; border:1px solid var(--border); transition:all 0.3s ease; }
        .card:hover { box-shadow:var(--shadow-lg); }
        .card-header { padding:16px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,var(--bg-elevated) 0%,var(--bg-card) 100%); display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .card-header h2 { font-size:0.95rem; font-weight:600; display:flex; align-items:center; gap:10px; white-space:nowrap; }
        .card-header [data-lucide] { width:20px; height:20px; color:var(--accent-blue); flex-shrink:0; }
        .card-body { padding:20px; }
        .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:20px; }
        @media (max-width:900px) { .stats-grid { grid-template-columns:repeat(2,1fr); } }
        @media (max-width:600px) { .stats-grid { grid-template-columns:1fr; gap:12px; } }
        .stat-card { background:var(--bg-card); border-radius:var(--radius-md); padding:20px; box-shadow:var(--shadow-md); border:1px solid var(--border); transition:all 0.3s ease; }
        .stat-card:hover { transform:translateY(-4px); box-shadow:var(--shadow-lg); }
        .stat-icon { width:48px; height:48px; border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; margin-bottom:14px; }
        .stat-card.primary .stat-icon { background:var(--accent-blue-bg); color:var(--accent-blue); }
        .stat-card.success .stat-icon { background:var(--accent-green-bg); color:var(--accent-green); }
        .stat-card.info .stat-icon { background:var(--accent-yellow-bg); color:var(--accent-yellow); }
        .stat-card.danger .stat-icon { background:var(--accent-red-bg); color:var(--accent-red); }
        .stat-icon [data-lucide] { width:24px; height:24px; }
        .stat-value { font-size:2.2rem; font-weight:700; line-height:1; margin-bottom:6px; }
        .stat-label { font-size:0.8rem; color:var(--text-secondary); }
        .table-wrap { overflow-x:auto; border-radius:var(--radius-sm); -webkit-overflow-scrolling:touch; }
        .table-wrap.with-border { border:1px solid var(--border); }
        .dashboard-table-wrap { overflow-x:auto; border:1px solid var(--border); border-radius:var(--radius-sm); -webkit-overflow-scrolling:touch; margin:0 16px; }
        table { width:100%; min-width:650px; border-collapse:collapse; }
        th,td { padding:14px 16px; text-align:left; white-space:nowrap; }
        th { background:var(--bg-tertiary); font-weight:500; font-size:0.8rem; color:var(--text-secondary); border-bottom:1px solid var(--border); text-transform:uppercase; letter-spacing:0.5px; }
        td { border-bottom:1px solid var(--border); font-size:0.85rem; background:var(--bg-card); transition:all 0.2s ease; }
        tr:last-child td { border-bottom:none; }
        tr:hover td { background:var(--bg-elevated); }
        .late-row td { background:var(--accent-red-bg) !important; }
        .late-row:hover td { background:rgba(239,68,68,0.2) !important; }
        .badge { display:inline-flex; align-items:center; gap:4px; padding:5px 12px; border-radius:20px; font-size:0.75rem; font-weight:500; white-space:nowrap; }
        .badge.success { background:var(--accent-green-bg); color:var(--accent-green); border:1px solid rgba(16,185,129,0.3); }
        .badge.danger { background:var(--accent-red-bg); color:var(--accent-red); border:1px solid rgba(239,68,68,0.3); }
        .badge.warning { background:var(--accent-yellow-bg); color:var(--accent-yellow); border:1px solid rgba(245,158,11,0.3); }
        .badge.secondary { background:var(--bg-tertiary); color:var(--text-secondary); border:1px solid var(--border); }
        .badge.info { background:var(--accent-blue-bg); color:var(--accent-blue); border:1px solid rgba(59,130,246,0.3); }
        .photo-thumb { width:42px; height:42px; border-radius:var(--radius-xs); object-fit:cover; cursor:pointer; border:2px solid var(--border); transition:all 0.3s ease; }
        .photo-thumb:hover { transform:scale(1.1); border-color:var(--accent-blue); box-shadow:var(--shadow-md); }
        .emp-cell { display:flex; align-items:center; gap:12px; }
        .emp-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 100%); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; font-size:0.95rem; box-shadow:var(--shadow-sm); }
        .emp-name { font-weight:500; white-space:nowrap; }
        .emp-id { font-size:0.7rem; color:var(--text-muted); }
        .action-btns { display:flex; gap:8px; }
        .action-btns .btn-icon { background:var(--bg-tertiary); color:var(--text-secondary); border:1px solid var(--border); width:40px !important; height:40px !important; min-width:40px !important; }
        .action-btns .btn-icon:hover { background:var(--accent-blue-bg); color:var(--accent-blue); border-color:var(--accent-blue); transform:scale(1.1); }
        .action-btns .btn-icon.danger:hover { background:var(--accent-red-bg); color:var(--accent-red); border-color:var(--accent-red); }
        .filter-row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
        .filter-row label { font-weight:500; font-size:0.85rem; color:var(--text-secondary); display:flex; align-items:center; white-space:nowrap; }
        .date-input-wrap { position:relative; }
        .date-input-wrap input { width:100%; height:44px; padding:0 12px; border:1px solid var(--border); border-radius:var(--radius-sm); font-family:'Kanit'; font-size:0.9rem; background:var(--bg-tertiary); color:var(--text-primary); transition:all 0.3s ease; cursor:pointer; -webkit-appearance:none; appearance:none; }
        .date-input-wrap input:focus { border-color:var(--accent-blue); box-shadow:var(--shadow-glow-blue); outline:none; }
        .date-input-wrap input::-webkit-calendar-picker-indicator { filter:invert(1); cursor:pointer; opacity:0.7; }
        .date-input-wrap input::-webkit-date-and-time-value { text-align:center; }
        .btn-row { display:flex; gap:10px; }
        .filter-row .btn { height:44px; white-space:nowrap; }
        .update-status { display:flex; justify-content:space-between; align-items:center; margin-top:16px; padding:12px 16px; background:var(--bg-tertiary); border-radius:var(--radius-sm); border:1px solid var(--border); flex-wrap:wrap; gap:12px; }
        .update-info { display:flex; align-items:center; gap:10px; color:var(--text-secondary); font-size:0.85rem; }
        .update-info [data-lucide] { width:16px; height:16px; color:var(--accent-blue); }
        .update-info strong { color:var(--text-primary); }
        .auto-refresh { display:flex; align-items:center; gap:8px; font-size:0.8rem; color:var(--text-muted); }
        .refresh-dot { width:8px; height:8px; background:var(--accent-green); border-radius:50%; animation:pulse 2s ease-in-out infinite; }
        @media (max-width:600px) { 
            .filter-row { display:flex; flex-direction:column; gap:10px; } 
            .filter-row label { display:none; } 
            .date-input-wrap { width:100%; }
            .btn-row { width:100%; }
            .btn-row .btn { flex:1; }
        }
        .charts-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:20px; margin-bottom:20px; }
        @media (max-width:800px) { .charts-grid { grid-template-columns:1fr; gap:16px; } }
        .chart-box { height:280px; position:relative; }
        @media (max-width:600px) { .chart-box { height:240px; } }
        .pagination { display:flex; justify-content:center; align-items:center; gap:6px; padding:16px; flex-wrap:wrap; }
        .pagination button { width:36px; height:36px; border:1px solid var(--border); background:var(--bg-tertiary); border-radius:var(--radius-xs); cursor:pointer; font-family:'Kanit'; font-weight:500; font-size:0.8rem; display:flex; align-items:center; justify-content:center; color:var(--text-primary); transition:all 0.3s ease; }
        .pagination button:hover:not(:disabled) { border-color:var(--accent-blue); color:var(--accent-blue); background:var(--accent-blue-bg); }
        .pagination button.active { background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-blue-dark) 100%); border-color:var(--accent-blue); color:white; box-shadow:var(--shadow-sm); }
        .pagination button:disabled { opacity:0.4; cursor:not-allowed; }
        .pagination [data-lucide] { width:14px; height:14px; }
        .pagination-info { font-size:0.75rem; color:var(--text-muted); margin:0 10px; }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; font-weight:500; margin-bottom:8px; font-size:0.85rem; color:var(--text-secondary); }
        .form-input,.form-select { width:100%; padding:12px 16px; border:1px solid var(--border); border-radius:var(--radius-sm); font-family:'Kanit'; font-size:0.9rem; transition:all 0.3s ease; background:var(--bg-tertiary); color:var(--text-primary); }
        .form-input:focus,.form-select:focus { outline:none; border-color:var(--accent-blue); box-shadow:var(--shadow-glow-blue); background:var(--bg-elevated); }
        .input-password-wrap { position:relative; display:flex; align-items:center; }
        .input-password-wrap .form-input { padding-right:44px; }
        .btn-toggle-password { position:absolute; right:8px; width:32px; height:32px; border:none; background:transparent; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--text-muted); transition:color 0.3s ease; border-radius:var(--radius-xs); }
        .btn-toggle-password:hover { color:var(--accent-blue); background:var(--accent-blue-bg); }
        .form-input:disabled { background:var(--bg-primary); color:var(--text-muted); }
        .form-select option { background:var(--bg-tertiary); color:var(--text-primary); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        @media (max-width:500px) { .form-row { grid-template-columns:1fr; } }
        .search-row { display:flex; gap:12px; margin-bottom:16px; align-items:center; flex-wrap:wrap; }
        .search-box { position:relative; flex:1; min-width:200px; }
        .search-box input { width:100%; padding:12px 14px 12px 42px; height:46px; }
        .search-box [data-lucide] { position:absolute; left:14px; top:50%; transform:translateY(-50%); width:18px; height:18px; color:var(--text-muted); transition:color 0.3s ease; }
        .search-box:focus-within [data-lucide] { color:var(--accent-blue); }
        @media (max-width:600px) { .search-row { flex-direction:column; gap:10px; } .search-box { width:100%; min-width:auto; } .search-row .btn { width:100%; } }
        .btn { padding:12px 22px; border:none; border-radius:var(--radius-sm); font-family:'Kanit'; font-size:0.9rem; font-weight:500; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s ease; }
        .btn [data-lucide] { width:18px; height:18px; }
        .btn-primary { background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-blue-dark) 100%); color:white; box-shadow:var(--shadow-sm); }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:var(--shadow-md),var(--shadow-glow-blue); }
        .btn-secondary { background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border); }
        .btn-secondary:hover { background:var(--bg-elevated); border-color:var(--border-light); transform:translateY(-2px); }
        .btn-success { background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); color:white; box-shadow:var(--shadow-sm); }
        .btn-success [data-lucide] { color:white; }
        .btn-success:hover { transform:translateY(-2px); box-shadow:var(--shadow-md),var(--shadow-glow-green); }
        .btn-sm { padding:10px 16px; font-size:0.85rem; }
        .btn-icon { width:40px; height:40px; min-width:40px; padding:0; border-radius:var(--radius-sm); display:flex; align-items:center; justify-content:center; }
        .btn-icon [data-lucide] { width:18px; height:18px; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }
        .face-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
        @media (max-width:768px) { .face-grid { grid-template-columns:1fr; gap:20px; } }
        .cam-preview { aspect-ratio:4/3; background:linear-gradient(135deg,#000 0%,var(--bg-primary) 100%); border-radius:var(--radius-md); overflow:hidden; position:relative; border:2px solid var(--border); box-shadow:var(--shadow-inner),var(--shadow-md); }
        .cam-preview video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
        .cam-preview canvas { position:absolute; inset:0; width:100%; height:100%; transform:scaleX(-1); }
        .face-status { padding:12px; border-radius:var(--radius-sm); text-align:center; font-weight:500; font-size:0.85rem; margin:14px 0; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.3s ease; }
        .face-status [data-lucide] { width:18px; height:18px; }
        .face-status.detecting { background:var(--accent-yellow-bg); color:var(--accent-yellow); border:1px solid rgba(245,158,11,0.3); }
        .face-status.detected { background:var(--accent-green-bg); color:var(--accent-green); border:1px solid rgba(16,185,129,0.3); box-shadow:var(--shadow-glow-green); }
        .instructions { background:linear-gradient(135deg,var(--accent-blue-bg) 0%,var(--accent-purple-bg) 100%); border:1px solid rgba(59,130,246,0.3); border-radius:var(--radius-md); padding:18px; margin-bottom:20px; }
        .instructions h4 { font-size:0.9rem; font-weight:600; color:var(--accent-blue-light); margin-bottom:10px; display:flex; align-items:center; gap:8px; }
        .instructions [data-lucide] { width:18px; height:18px; }
        .instructions ul { list-style:none; font-size:0.8rem; color:var(--text-secondary); }
        .instructions li { padding:4px 0 4px 24px; position:relative; }
        .instructions li::before { content:'✓'; position:absolute; left:0; color:var(--accent-green); font-weight:600; }
        .selected-emp { display:flex; align-items:center; gap:12px; padding:14px; background:var(--bg-tertiary); border-radius:var(--radius-sm); margin-bottom:14px; border:1px solid var(--border); transition:all 0.3s ease; }
        .selected-emp .avatar { width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 100%); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:1.1rem; box-shadow:var(--shadow-sm); }
        .selected-emp .info h4 { font-size:0.95rem; font-weight:600; }
        .selected-emp .info p { font-size:0.75rem; color:var(--text-secondary); }
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; visibility:hidden; transition:all 0.3s ease; padding:16px; }
        .modal-overlay.active { opacity:1; visibility:visible; }
        .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:28px; max-width:420px; width:100%; max-height:calc(100vh - 32px); overflow-y:auto; transform:scale(0.9) translateY(20px); transition:all 0.3s ease; position:relative; box-shadow:var(--shadow-xl); }
        .modal-overlay.active .modal { transform:scale(1) translateY(0); }
        @media (max-width:480px) { .modal { padding:20px; border-radius:var(--radius-md); } }
        .modal-close { position:absolute; top:16px; right:16px; width:36px; height:36px; background:var(--bg-tertiary); border:1px solid var(--border); border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--text-secondary); transition:all 0.3s ease; }
        .modal-close:hover { background:var(--accent-red-bg); border-color:var(--accent-red); color:var(--accent-red); transform:rotate(90deg); }
        .modal-close [data-lucide] { width:18px; height:18px; }
        .modal-icon { width:72px; height:72px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; animation:scaleIn 0.3s ease 0.1s both; }
        .modal-icon.success { background:var(--accent-green-bg); color:var(--accent-green); box-shadow:var(--shadow-glow-green); }
        .modal-icon.error { background:var(--accent-red-bg); color:var(--accent-red); box-shadow:var(--shadow-glow-red); }
        .modal-icon.warning { background:var(--accent-yellow-bg); color:var(--accent-yellow); }
        .modal-icon.login { background:linear-gradient(135deg,var(--accent-blue-bg) 0%,var(--accent-purple-bg) 100%); color:var(--accent-blue); box-shadow:var(--shadow-glow-blue); }
        .modal-icon [data-lucide] { width:36px; height:36px; }
        .modal-title { font-size:1.25rem; font-weight:600; text-align:center; margin-bottom:10px; }
        .modal-message { text-align:center; color:var(--text-secondary); margin-bottom:24px; line-height:1.6; white-space:pre-line; font-size:0.9rem; }
        .empty-state { text-align:center; padding:48px 24px; color:var(--text-secondary); }
        .empty-state [data-lucide] { width:48px; height:48px; margin-bottom:16px; opacity:0.3; }
        .stats-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px 20px; color:var(--text-secondary); }
        .stats-loading .loader-ring { width:40px; height:40px; margin-bottom:0; }
        .stats-loading p { margin-top:16px; }
        .emp-stats-header { display:flex; align-items:center; gap:16px; padding:16px; background:var(--bg-tertiary); border-radius:var(--radius-sm); margin-bottom:20px; }
        .emp-stats-avatar { width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.5rem; font-weight:700; }
        .emp-stats-info h4 { font-size:1.1rem; margin-bottom:4px; }
        .emp-stats-info p { font-size:0.85rem; color:var(--text-secondary); }
        .stats-summary { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:20px; }
        .stat-box { text-align:center; padding:16px 12px; background:var(--bg-tertiary); border-radius:var(--radius-sm); border:1px solid var(--border); }
        .stat-box .stat-num { font-size:1.8rem; font-weight:700; margin-bottom:4px; }
        .stat-box .stat-txt { font-size:0.75rem; color:var(--text-secondary); }
        .stat-box.green .stat-num { color:var(--accent-green); }
        .stat-box.red .stat-num { color:var(--accent-red); }
        .stat-box.yellow .stat-num { color:var(--accent-yellow); }
        @media (max-width:400px) { .stats-summary { grid-template-columns:1fr; } }
        .fiscal-year-info { text-align:center; padding:12px 16px; background:var(--accent-blue-bg); border:1px solid rgba(59,130,246,0.3); border-radius:var(--radius-sm); color:var(--text-secondary); font-size:0.8rem; margin-top:16px; }
        .fiscal-year-info strong { color:var(--accent-blue-light); }
        .export-modal .modal { max-width:340px; width:calc(100% - 32px); }
        .export-form { margin-top:20px; }
        .export-form .form-group { margin-bottom:16px; }
        .export-form .form-group label { margin-bottom:6px; display:block; }
        .export-form .form-input { height:44px; padding:0 12px; width:100%; max-width:100%; box-sizing:border-box; -webkit-appearance:none; appearance:none; }
        .export-form .form-input::-webkit-date-and-time-value { text-align:center; }
        .export-actions { display:flex; gap:12px; margin-top:24px; }
        .export-actions .btn { flex:1; height:44px; }
        .export-actions { display:flex; gap:12px; margin-top:24px; }
        .export-actions .btn { flex:1; height:44px; }
        @media (max-width:480px) { html { font-size:15px; } .att-container { padding:0 12px; padding-bottom:calc(20px + var(--safe-bottom)); padding-top:100px; } }
        @media (max-width:360px) { html { font-size:14px; } .shift-grid { grid-template-columns:1fr; gap:8px; } .tabs { flex-direction:column; } .tab-btn { width:100%; } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader-ring"></div>
        <div class="loading-text" id="loadingText">กำลังโหลด...</div>
        <div class="progress-bar"><div class="progress-fill" id="loadingProgress" style="width:0%"></div></div>
    </div>

    <div class="page att-page" id="pageAttendance">
        <header class="att-header">
            <div class="att-logo"><div class="icon"><i data-lucide="scan-face"></i></div><h1>ลงเวลาทำงาน</h1></div>
            <button class="login-btn" onclick="showLoginModal()"><i data-lucide="shield"></i><span>Admin</span></button>
        </header>
        <div class="att-container">
            <div class="main-card">
                <div class="time-section">
                    <div class="time-display" id="currentTime">00:00:00</div>
                    <div class="date-display" id="currentDate">-</div>
                </div>
                <div class="status-section">
                    <div class="status-card" id="faceStatus"><i data-lucide="scan-face"></i><span>รอตรวจจับใบหน้า</span></div>
                </div>
                <div class="shift-section">
                    <div class="section-label"><i data-lucide="clock"></i><span>เลือกผลัดการทำงาน</span></div>
                    <div class="shift-grid">
                        <button class="shift-btn" data-shift="morning"><div class="name">ผลัดเช้า</div><div class="time">06:00-14:00</div></button>
                        <button class="shift-btn" data-shift="afternoon"><div class="name">ผลัดบ่าย</div><div class="time">14:00-22:00</div></button>
                        <button class="shift-btn" data-shift="daywork"><div class="name">Daywork</div><div class="time">08:30-16:30</div></button>
                    </div>
                </div>
                <div class="camera-section">
                    <div class="camera-wrapper">
                        <video id="video" autoplay playsinline muted></video>
                        <canvas id="overlayCanvas"></canvas>
                        <div class="camera-placeholder" id="cameraPlaceholder"><i data-lucide="camera"></i><p>กำลังเปิดกล้อง...</p></div>
                    </div>
                </div>
                <div class="matched-section hidden" id="matchedSection">
                    <div class="matched-avatar" id="matchedAvatar">-</div>
                    <div class="matched-info"><h3 id="matchedName">-</h3><p id="matchedPosition">-</p></div>
                    <div class="confidence-badge"><div class="value" id="matchConfidence">0%</div><div class="label">ความแม่นยำ</div></div>
                </div>
                <div class="action-inner">
                    <button class="action-btn checkin" id="btnCheckIn" disabled><i data-lucide="log-in"></i><span>เข้างาน</span></button>
                    <button class="action-btn checkout" id="btnCheckOut" disabled><i data-lucide="log-out"></i><span>ออกงาน</span></button>
                </div>
            </div>
        </div>
    </div>

    <div class="page admin-page" id="pageAdmin">
        <header class="admin-header">
            <div class="admin-header-inner">
                <div class="admin-title"><i data-lucide="settings-2"></i><h1>ระบบจัดการ</h1></div>
                <button class="avatar-btn" onclick="toggleSidebar()" id="adminAvatarBtn">A</button>
            </div>
        </header>
        <div class="admin-container">
            <div class="tabs">
                <button class="tab-btn active" data-tab="employees"><i data-lucide="users"></i>รายชื่อ</button>
                <button class="tab-btn" data-tab="register-face"><i data-lucide="scan-face"></i>ลงทะเบียนใบหน้า</button>
            </div>
            <div class="tab-content active" id="tab-employees">
                <div class="card">
                    <div class="card-header"><h2><i data-lucide="users"></i>รายชื่อพนักงานทั้งหมด</h2></div>
                    <div class="card-body">
                        <div class="search-row">
                            <div class="search-box"><i data-lucide="search"></i><input type="text" class="form-input" id="searchEmployee" placeholder="ค้นหาพนักงาน..." onkeyup="filterEmployees()"></div>
                            <button class="btn btn-primary" onclick="showAddEmployeeModal()"><i data-lucide="user-plus"></i>เพิ่มพนักงาน</button>
                        </div>
                        <div class="table-wrap with-border">
                            <table><thead><tr><th>พนักงาน</th><th>ตำแหน่ง</th><th>กลุ่ม</th><th>สถานะใบหน้า</th><th>สถิติ</th><th id="thManage">จัดการ</th></tr></thead>
                            <tbody id="employeeTableBody"><tr><td colspan="6" class="empty-state">กำลังโหลด...</td></tr></tbody></table>
                        </div>
                        <div class="pagination" id="empPagination"></div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="tab-register-face">
                <div class="card">
                    <div class="card-header"><h2><i data-lucide="scan-face"></i>ลงทะเบียนใบหน้า</h2></div>
                    <div class="card-body">
                        <div class="instructions"><h4><i data-lucide="info"></i>วิธีลงทะเบียน</h4><ul><li>เลือกพนักงาน</li><li>หันหน้าตรงเข้ากล้อง</li><li>รอกรอบสีเขียว</li><li>กดบันทึก</li></ul></div>
                        <div class="face-grid">
                            <div>
                                <div class="section-label"><i data-lucide="camera"></i><span>กล้อง</span><button class="btn btn-icon" onclick="switchCamera()" id="btnSwitchCam" title="สลับกล้อง" style="margin-left:auto"><i data-lucide="refresh-cw"></i></button></div>
                                <div class="cam-preview">
                                    <video id="regVideo" autoplay playsinline muted></video>
                                    <canvas id="regCanvas"></canvas>
                                    <div class="camera-placeholder" id="regPlaceholder"><i data-lucide="camera"></i><p>เลือกพนักงาน</p></div>
                                </div>
                                <div class="face-status detecting" id="regFaceStatus"><i data-lucide="scan-face"></i><span>รอตรวจจับ...</span></div>
                                <button class="btn btn-success" id="btnSaveFace" disabled style="width:100%"><i data-lucide="save"></i>บันทึกใบหน้า</button>
                            </div>
                            <div>
                                <div class="section-label"><i data-lucide="user"></i><span>เลือกพนักงาน</span></div>
                                <div class="form-group"><select class="form-select" id="regEmployeeSelect"><option value="">-- เลือกพนักงาน --</option></select></div>
                                <div class="selected-emp hidden" id="selectedEmployee">
                                    <div class="avatar" id="selectedAvatar">-</div>
                                    <div class="info"><h4 id="selectedName">-</h4><p id="selectedPosition">-</p></div>
                                </div>
                                <div id="currentFaceStatus" class="hidden" style="margin-top:14px"><p style="color:var(--text-secondary);font-size:0.8rem;margin-bottom:6px">สถานะ:</p><div id="faceRegistrationStatus"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="page admin-page" id="pageDashboard">
        <header class="admin-header">
            <div class="admin-header-inner">
                <div class="admin-title"><i data-lucide="bar-chart-3"></i><h1>Dashboard</h1></div>
                <button class="avatar-btn" onclick="toggleSidebar()" id="dashAvatarBtn">A</button>
            </div>
        </header>
        <div class="admin-container">
            <div class="card">
                <div class="card-body">
                    <div class="filter-row">
                        <label>เลือกวันที่:</label>
                        <div class="date-input-wrap">
                            <input type="date" id="dashboardDate">
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-secondary btn-sm" onclick="setToday()" id="btnToday"><i data-lucide="calendar"></i>วันนี้</button>
                            <button class="btn btn-primary btn-sm" onclick="loadDashboard()" id="btnLoadDash"><i data-lucide="search"></i>ดูข้อมูล</button>
                        </div>
                    </div>
                    <div class="update-status" id="updateStatus">
                        <div class="update-info"><i data-lucide="refresh-cw"></i><span>อัปเดทล่าสุด: <strong id="lastUpdateTime">-</strong></span></div>
                        <div class="auto-refresh"><span class="refresh-dot"></span><span>รีเฟรชอัตโนมัติทุก 5 นาที</span></div>
                    </div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card primary"><div class="stat-icon"><i data-lucide="users"></i></div><div class="stat-value" id="statTotal">-</div><div class="stat-label">พนักงานทั้งหมด</div></div>
                <div class="stat-card success"><div class="stat-icon"><i data-lucide="log-in"></i></div><div class="stat-value" id="statCheckins">-</div><div class="stat-label">เข้างานแล้ว</div></div>
                <div class="stat-card info"><div class="stat-icon"><i data-lucide="log-out"></i></div><div class="stat-value" id="statCheckouts">-</div><div class="stat-label">ออกงานแล้ว</div></div>
                <div class="stat-card danger"><div class="stat-icon"><i data-lucide="alarm-clock"></i></div><div class="stat-value" id="statLate">-</div><div class="stat-label">มาสาย</div></div>
            </div>
            <div class="charts-grid">
                <div class="card"><div class="card-header"><h2><i data-lucide="pie-chart"></i>สถิติตามผลัด</h2></div><div class="card-body"><div class="chart-box"><canvas id="shiftChart"></canvas></div></div></div>
                <div class="card"><div class="card-header"><h2><i data-lucide="bar-chart-2"></i>สถานะการเข้างาน</h2></div><div class="card-body"><div class="chart-box"><canvas id="statusChart"></canvas></div></div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i data-lucide="list"></i>รายละเอียดการลงเวลา</h2>
                    <button class="btn btn-success btn-sm" onclick="showExportModal()" id="btnExport"><i data-lucide="download"></i>Excel</button>
                </div>
                <div class="card-body" style="padding-bottom:0">
                    <div class="search-box" style="margin-bottom:16px"><i data-lucide="search"></i><input type="text" class="form-input" id="searchDashboard" placeholder="ค้นหา (ชื่อ, รหัส, ผลัด, สถานะ)..." onkeyup="filterDashboard()"></div>
                </div>
                <div class="dashboard-table-wrap">
                    <table><thead><tr><th>พนักงาน</th><th>ผลัด</th><th>เข้างาน</th><th>รูปเข้า</th><th>ออกงาน</th><th>รูปออก</th><th>สถานะ</th></tr></thead>
                    <tbody id="dashboardTable"><tr><td colspan="7" class="empty-state">เลือกวันที่</td></tr></tbody></table>
                </div>
                <div class="pagination" id="dashPagination"></div>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <button class="sidebar-close" onclick="closeSidebar()"><i data-lucide="x"></i></button>
        <div class="sidebar-header">
            <div class="sidebar-avatar" id="sidebarAvatar" onclick="showEditUserModal()" style="cursor:pointer" title="แก้ไขบัญชี">A</div>
            <div class="sidebar-user"><h3 id="sidebarUsername">Admin</h3><p id="sidebarRole">ผู้ดูแลระบบ</p></div>
        </div>
        <nav class="sidebar-nav">
            <button class="sidebar-nav-btn" onclick="navigateTo('pageAttendance')" data-page="pageAttendance"><i data-lucide="clock"></i><span>ลงเวลา</span></button>
            <button class="sidebar-nav-btn" onclick="navigateTo('pageAdmin')" data-page="pageAdmin"><i data-lucide="settings-2"></i><span>จัดการพนักงาน</span></button>
            <button class="sidebar-nav-btn" onclick="navigateTo('pageDashboard')" data-page="pageDashboard"><i data-lucide="bar-chart-3"></i><span>Dashboard</span></button>
            <button class="sidebar-nav-btn" onclick="navigateTo('pageEditLog')" data-page="pageEditLog"><i data-lucide="history"></i><span>ประวัติการแก้ไข</span></button>
            <button class="sidebar-nav-btn" onclick="navigateTo('pageUsers')" data-page="pageUsers" id="menuUsers"><i data-lucide="users-round"></i><span>ข้อมูลผู้ใช้</span></button>
            <button class="sidebar-nav-btn logout" onclick="logout()"><i data-lucide="log-out"></i><span>ออกจากระบบ</span></button>
        </nav>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <button class="modal-close" onclick="closeLoginModal()"><i data-lucide="x"></i></button>
            <div class="modal-icon login"><i data-lucide="shield"></i></div>
            <h3 class="modal-title">เข้าสู่ระบบ</h3>
            <form id="loginForm">
                <div class="form-group"><label>ชื่อผู้ใช้</label><input type="text" class="form-input" id="loginUsername" required></div>
                <div class="form-group"><label>รหัสผ่าน</label><div class="input-password-wrap"><input type="password" class="form-input" id="loginPassword" required><button type="button" class="btn-toggle-password" onclick="togglePassword('loginPassword',this)"><i data-lucide="eye"></i></button></div></div>
                <button type="submit" class="btn btn-primary" style="width:100%"><i data-lucide="log-in"></i>เข้าสู่ระบบ</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="addEmployeeModal">
        <div class="modal" style="max-width:480px">
            <button class="modal-close" onclick="closeAddEmployeeModal()"><i data-lucide="x"></i></button>
            <div class="modal-icon login"><i data-lucide="user-plus"></i></div>
            <h3 class="modal-title">เพิ่มพนักงานใหม่</h3>
            <form id="addEmployeeForm">
                <div class="form-row">
                    <div class="form-group"><label>รหัสพนักงาน (Auto)</label><input type="text" class="form-input" id="newEmpId" disabled></div>
                    <div class="form-group">
                        <label>คำนำหน้า</label>
                        <select class="form-select" id="newEmpTitle" onchange="handleTitleChange()">
                            <option value="">-- เลือก --</option>
                            <option value="นาย">นาย</option>
                            <option value="นาง">นาง</option>
                            <option value="นางสาว">นางสาว</option>
                            <option value="เด็กชาย">เด็กชาย</option>
                            <option value="เด็กหญิง">เด็กหญิง</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group hidden" id="customTitleGroup">
                    <label>ระบุคำนำหน้า</label>
                    <input type="text" class="form-input" id="customTitle" placeholder="พิมพ์คำนำหน้า...">
                </div>
                <div class="form-group"><label>ชื่อ-สกุล</label><input type="text" class="form-input" id="newEmpName" placeholder="กรอกชื่อ-สกุล" required></div>
                <div class="form-row">
                    <div class="form-group"><label>ตำแหน่ง</label><input type="text" class="form-input" id="newEmpPosition" placeholder="กรอกตำแหน่ง"></div>
                    <div class="form-group"><label>กลุ่ม</label><input type="text" class="form-input" id="newEmpGroup" placeholder="กรอกกลุ่ม"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%;margin-top:10px"><i data-lucide="plus"></i>เพิ่มพนักงาน</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div class="modal-icon" id="resultIcon"><i data-lucide="check"></i></div>
            <h3 class="modal-title" id="resultTitle">สำเร็จ</h3>
            <p class="modal-message" id="resultMessage">-</p>
            <button class="btn btn-primary" onclick="closeResultModal()" style="width:100%">ตกลง</button>
        </div>
    </div>

    <div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
        <div style="position:relative;max-width:500px;width:calc(100% - 32px);margin:auto" onclick="event.stopPropagation()">
            <button class="modal-close" style="position:absolute;top:12px;right:12px;z-index:10" onclick="closeImageModal()"><i data-lucide="x"></i></button>
            <img id="previewImage" src="" style="width:100%;border-radius:var(--radius-md);display:block;box-shadow:var(--shadow-xl)">
        </div>
    </div>

    <div class="modal-overlay" id="employeeStatsModal">
        <div class="modal" style="max-width:480px">
            <button class="modal-close" onclick="closeEmployeeStatsModal()"><i data-lucide="x"></i></button>
            <h3 class="modal-title"><i data-lucide="bar-chart-2" style="width:20px;height:20px;margin-right:8px"></i>สถิติพนักงาน</h3>
            <div id="employeeStatsContent"><div class="stats-loading"><div class="loader-ring"></div><p>กำลังโหลดข้อมูล...</p></div></div>
        </div>
    </div>

    <div class="modal-overlay export-modal" id="exportModal">
        <div class="modal">
            <button class="modal-close" onclick="closeExportModal()"><i data-lucide="x"></i></button>
            <div class="modal-icon login"><i data-lucide="download"></i></div>
            <h3 class="modal-title">ดาวน์โหลด Excel</h3>
            <div class="export-form">
                <div class="form-group">
                    <label>วันที่เริ่มต้น</label>
                    <input type="date" class="form-input" id="exportStartDate">
                </div>
                <div class="form-group">
                    <label>วันที่สิ้นสุด</label>
                    <input type="date" class="form-input" id="exportEndDate">
                </div>
                <div class="export-actions">
                    <button class="btn btn-secondary" onclick="closeExportModal()">ยกเลิก</button>
                    <button class="btn btn-success" onclick="exportToExcel()" id="btnDoExport"><i data-lucide="file-spreadsheet"></i>ดาวน์โหลด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div class="modal-overlay" id="editEmployeeModal">
        <div class="modal" style="max-width:480px">
            <button class="modal-close" onclick="closeEditEmployeeModal()"><i data-lucide="x"></i></button>
            <div class="modal-icon login"><i data-lucide="user-pen"></i></div>
            <h3 class="modal-title">แก้ไขข้อมูลพนักงาน</h3>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmpIdHidden">
                <div class="form-row">
                    <div class="form-group"><label>รหัสพนักงาน</label><input type="text" class="form-input" id="editEmpId" disabled></div>
                    <div class="form-group">
                        <label>คำนำหน้า</label>
                        <select class="form-select" id="editEmpTitle">
                            <option value="">-- เลือก --</option>
                            <option value="นาย">นาย</option>
                            <option value="นาง">นาง</option>
                            <option value="นางสาว">นางสาว</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>ชื่อ-สกุล</label><input type="text" class="form-input" id="editEmpName" required></div>
                <div class="form-row">
                    <div class="form-group"><label>ตำแหน่ง</label><input type="text" class="form-input" id="editEmpPosition"></div>
                    <div class="form-group"><label>กลุ่ม</label><input type="text" class="form-input" id="editEmpGroup"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%"><i data-lucide="save"></i>บันทึกการแก้ไข</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal" style="max-width:400px">
            <button class="modal-close" onclick="closeEditUserModal()"><i data-lucide="x"></i></button>
            <div class="modal-icon login"><i data-lucide="user-cog"></i></div>
            <h3 class="modal-title">แก้ไขบัญชีผู้ใช้</h3>
            <form id="editUserForm">
                <div class="form-group"><label>ชื่อผู้ใช้</label><input type="text" class="form-input" id="editUsername" required></div>
                <div class="form-group"><label>รหัสผ่านเดิม</label><div class="input-password-wrap"><input type="password" class="form-input" id="editOldPassword" required><button type="button" class="btn-toggle-password" onclick="togglePassword('editOldPassword',this)"><i data-lucide="eye"></i></button></div></div>
                <div class="form-group"><label>รหัสผ่านใหม่ (เว้นว่างถ้าไม่เปลี่ยน)</label><div class="input-password-wrap"><input type="password" class="form-input" id="editNewPassword"><button type="button" class="btn-toggle-password" onclick="togglePassword('editNewPassword',this)"><i data-lucide="eye"></i></button></div></div>
                <div class="form-group"><label>ชื่อที่แสดง</label><input type="text" class="form-input" id="editDisplayName" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%"><i data-lucide="save"></i>บันทึก</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal" style="max-width:400px">
            <button class="modal-close" onclick="closeAddUserModal()"><i data-lucide="x"></i></button>
            <div class="modal-icon login"><i data-lucide="user-plus"></i></div>
            <h3 class="modal-title">เพิ่มผู้ใช้ใหม่</h3>
            <form id="addUserForm">
                <div class="form-group"><label>ชื่อผู้ใช้</label><input type="text" class="form-input" id="newUsername" required></div>
                <div class="form-group"><label>รหัสผ่าน</label><div class="input-password-wrap"><input type="password" class="form-input" id="newUserPassword" required><button type="button" class="btn-toggle-password" onclick="togglePassword('newUserPassword',this)"><i data-lucide="eye"></i></button></div></div>
                <div class="form-group"><label>ชื่อที่แสดง</label><input type="text" class="form-input" id="newDisplayName" required></div>
                <div class="form-group">
                    <label>สิทธิ์</label>
                    <select class="form-select" id="newUserRole">
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%"><i data-lucide="user-plus"></i>เพิ่มผู้ใช้</button>
            </form>
        </div>
    </div>

    <!-- EditLog Page -->
    <div class="page admin-page" id="pageEditLog">
        <header class="admin-header">
            <div class="admin-header-inner">
                <div class="admin-title"><i data-lucide="history"></i><h1>ประวัติการแก้ไข</h1></div>
                <button class="avatar-btn" onclick="toggleSidebar()" id="editlogAvatarBtn">A</button>
            </div>
        </header>
        <div class="admin-container">
            <div class="card">
                <div class="card-header"><h2><i data-lucide="file-clock"></i>รายการแก้ไขทั้งหมด</h2></div>
                <div class="card-body">
                    <div class="search-box" style="margin-bottom:16px"><i data-lucide="search"></i><input type="text" class="form-input" id="searchEditLog" placeholder="ค้นหา..." onkeyup="filterEditLogs()"></div>
                    <div class="table-wrap with-border">
                        <table><thead><tr><th>วันที่-เวลา</th><th>ผู้แก้ไข</th><th>ประเภท</th><th>รหัส</th><th>รายละเอียด</th></tr></thead>
                        <tbody id="editLogTableBody"><tr><td colspan="5" class="empty-state">กำลังโหลด...</td></tr></tbody></table>
                    </div>
                    <div class="pagination" id="editLogPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Page -->
    <div class="page admin-page" id="pageUsers">
        <header class="admin-header">
            <div class="admin-header-inner">
                <div class="admin-title"><i data-lucide="users-round"></i><h1>ข้อมูลผู้ใช้</h1></div>
                <button class="avatar-btn" onclick="toggleSidebar()" id="usersAvatarBtn">A</button>
            </div>
        </header>
        <div class="admin-container">
            <div class="card">
                <div class="card-header"><h2><i data-lucide="users"></i>รายชื่อผู้ใช้ทั้งหมด</h2></div>
                <div class="card-body">
                    <div class="search-row">
                        <div class="search-box"><i data-lucide="search"></i><input type="text" class="form-input" id="searchUsers" placeholder="ค้นหาผู้ใช้..." onkeyup="filterUsers()"></div>
                        <button class="btn btn-primary" onclick="showAddUserModal()"><i data-lucide="user-plus"></i>เพิ่มผู้ใช้</button>
                    </div>
                    <div class="table-wrap with-border">
                        <table><thead><tr><th>Username</th><th>ชื่อ</th><th>Role</th><th>จัดการ</th></tr></thead>
                        <tbody id="usersTableBody"><tr><td colspan="4" class="empty-state">กำลังโหลด...</td></tr></tbody></table>
                    </div>
                    <div class="pagination" id="usersPagination"></div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="captureCanvas" style="display:none"></canvas>

    <script>
        const API_URL='https://script.google.com/macros/s/AKfycbyYxW57e0Ev_kPMxdXMlWURSlSHmXZ9PDrrBvtX8GmmB3hAxrwZfifXToNid6T6kakR/exec';
        const FIREBASE_URL='https://employee-attendance-89b36-default-rtdb.asia-southeast1.firebasedatabase.app';
        const FACE_MATCH_THRESHOLD=0.5;
        const ITEMS_PER_PAGE=15;
        const WORK_AREAS=[[{lat:17.3861777,lng:102.7767161},{lat:17.3872041,lng:102.7746373},{lat:17.3875573,lng:102.7748224},{lat:17.3865079,lng:102.7768904}],[{lat:17.3848262,lng:102.7795136},{lat:17.3846239,lng:102.7793580},{lat:17.3845574,lng:102.7794948},{lat:17.3847878,lng:102.7796370}]];

        let currentUser=null,currentLocation=null,videoStream=null,employees=[],allEmployees=[];
        let matchedEmployee=null,faceDescriptor=null,isDetecting=false,detectionInterval=null,selectedShift=null;
        let regVideoStream=null,regDetectionInterval=null,regFaceDescriptor=null,selectedRegEmployee=null;
        let shiftChart=null,statusChart=null,dashboardRecords=[],currentPage=1,empPage=1,filteredEmployees=[];
        let userSelectedDate=null,allDashboardRecords=[];
        const spinnerSVG='<svg class="spinner" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>';

        async function firebaseSet(path,data){try{await fetch(FIREBASE_URL+'/'+path+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});return true;}catch(e){return false;}}
        async function firebaseGet(path){try{const r=await fetch(FIREBASE_URL+'/'+path+'.json');return r.json();}catch(e){return null;}}
        async function firebasePush(path,data){try{const r=await fetch(FIREBASE_URL+'/'+path+'.json',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});return r.json();}catch(e){return null;}}
        async function firebaseDelete(path){try{await fetch(FIREBASE_URL+'/'+path+'.json',{method:'DELETE'});return true;}catch(e){return false;}}

        function getFirstNameChar(fullName,title){let name=fullName||'';if(title&&name.startsWith(title))name=name.substring(title.length).trim();return name.charAt(0).toUpperCase()||'?';}

        document.addEventListener('DOMContentLoaded',async()=>{
            if(window.navigator.standalone===true||(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)){document.documentElement.classList.add('pwa-standalone');}
            const savedPage=localStorage.getItem('currentPage');
            const savedUser=localStorage.getItem('currentUser');
            let initialPage='pageAttendance';
            if(savedUser){currentUser=JSON.parse(savedUser);initialPage=savedPage||'pageDashboard';}
            document.getElementById(initialPage).classList.add('active');
            updateSidebarActive(initialPage);
            lucide.createIcons();updateDateTime();setInterval(updateDateTime,1000);setupEvents();requestGPS();
            if(currentUser)updateSidebarUser();
            await loadFaceAPI();await loadEmployees();await startCamera();startDetection();
            if(currentUser)renderEmpTable();
            if(initialPage==='pageDashboard')setToday();
        });

        function requestGPS(){if(!navigator.geolocation)return;navigator.geolocation.getCurrentPosition(pos=>{currentLocation={latitude:pos.coords.latitude,longitude:pos.coords.longitude};},err=>{},{enableHighAccuracy:true,timeout:15000});}
        function refreshGPS(){return new Promise((resolve,reject)=>{if(!navigator.geolocation){reject('ไม่รองรับ GPS');return;}navigator.geolocation.getCurrentPosition(pos=>{currentLocation={latitude:pos.coords.latitude,longitude:pos.coords.longitude};resolve(currentLocation);},err=>reject('ไม่สามารถระบุพิกัดได้'),{enableHighAccuracy:true,timeout:10000,maximumAge:0});});}

        function setupEvents(){
            document.querySelectorAll('.shift-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.shift-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');selectedShift=b.dataset.shift;checkBtns();}));
            document.getElementById('btnCheckIn').addEventListener('click',()=>recordAtt('checkIn'));
            document.getElementById('btnCheckOut').addEventListener('click',()=>recordAtt('checkOut'));
            document.getElementById('loginForm').addEventListener('submit',handleLogin);
            document.getElementById('addEmployeeForm').addEventListener('submit',handleAddEmp);
            document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));b.classList.add('active');document.getElementById('tab-'+b.dataset.tab).classList.add('active');if(b.dataset.tab!=='register-face')stopRegCam();lucide.createIcons();}));
            document.getElementById('regEmployeeSelect').addEventListener('change',handleRegChange);
            document.getElementById('btnSaveFace').addEventListener('click',saveFace);
        }

        async function loadFaceAPI(){const URL='https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';try{document.getElementById('loadingText').textContent='โหลด Face Detection...';document.getElementById('loadingProgress').style.width='25%';await faceapi.nets.tinyFaceDetector.loadFromUri(URL);document.getElementById('loadingText').textContent='โหลด Landmarks...';document.getElementById('loadingProgress').style.width='50%';await faceapi.nets.faceLandmark68Net.loadFromUri(URL);document.getElementById('loadingText').textContent='โหลด Recognition...';document.getElementById('loadingProgress').style.width='75%';await faceapi.nets.faceRecognitionNet.loadFromUri(URL);document.getElementById('loadingText').textContent='พร้อมใช้งาน!';document.getElementById('loadingProgress').style.width='100%';setTimeout(()=>document.getElementById('loadingOverlay').classList.add('hidden'),500);}catch(e){document.getElementById('loadingText').textContent='โหลดไม่สำเร็จ';}}

        async function callAPI(data){const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(data)});return r.json();}
        function capturePhoto(v){const c=document.getElementById('captureCanvas'),ctx=c.getContext('2d');c.width=v.videoWidth;c.height=v.videoHeight;ctx.translate(c.width,0);ctx.scale(-1,1);ctx.drawImage(v,0,0);return c.toDataURL('image/jpeg',0.8);}

        async function loadEmployees(){try{const r=await callAPI({action:'getEmployeesWithFace'});if(r.status==='success'){allEmployees=r.data;const faceData=await firebaseGet('faceData');if(faceData){allEmployees.forEach(emp=>{if(faceData[emp.id]){emp.faceDescriptor=faceData[emp.id].descriptor;emp.hasFaceData=true;}});}employees=allEmployees.filter(e=>e.hasFaceData);filteredEmployees=[...allEmployees];renderEmpTable();populateRegSelect();}}catch(e){console.error(e);}}
        async function loadNextId(){try{const r=await callAPI({action:'getNextEmployeeId'});if(r.status==='success')document.getElementById('newEmpId').value=r.nextId;}catch(e){}}

        function renderEmpTable(){const tbody=document.getElementById('employeeTableBody');const total=Math.ceil(filteredEmployees.length/ITEMS_PER_PAGE);const start=(empPage-1)*ITEMS_PER_PAGE;const pageData=filteredEmployees.slice(start,start+ITEMS_PER_PAGE);const isAdmin=currentUser&&currentUser.role==='admin';document.getElementById('thManage').style.display=isAdmin?'':'none';if(!filteredEmployees.length){tbody.innerHTML='<tr><td colspan="'+(isAdmin?6:5)+'" class="empty-state"><i data-lucide="users"></i><p>ไม่พบข้อมูล</p></td></tr>';document.getElementById('empPagination').innerHTML='';lucide.createIcons();return;}tbody.innerHTML=pageData.map(e=>{const avatarChar=getFirstNameChar(e.name,e.title);return '<tr><td><div class="emp-cell"><div class="emp-avatar">'+avatarChar+'</div><div><div class="emp-name">'+(e.fullName||e.name)+'</div><div class="emp-id">'+e.id+'</div></div></div></td><td>'+(e.position||'-')+'</td><td>'+(e.group||'-')+'</td><td><span class="badge '+(e.hasFaceData?'success':'warning')+'">'+(e.hasFaceData?'ลงทะเบียนแล้ว':'ยังไม่ลงทะเบียน')+'</span></td><td><div class="action-btns"><button class="btn btn-icon" onclick="showEmployeeStats(\''+e.id+'\',\''+(e.fullName||e.name).replace(/'/g,"\\'")+'\')"><i data-lucide="bar-chart-2"></i></button></div></td>'+(isAdmin?'<td><div class="action-btns"><button class="btn btn-icon" onclick="showEditEmployeeModal(\''+e.id+'\')"><i data-lucide="pencil"></i></button><button class="btn btn-icon" onclick="selectForReg(\''+e.id+'\')"><i data-lucide="camera"></i></button>'+(e.hasFaceData?'<button class="btn btn-icon danger" onclick="deleteFace(\''+e.id+'\')"><i data-lucide="trash-2"></i></button>':'')+'</div></td>':'')+'</tr>';}).join('');renderPagination('empPagination',total,empPage,p=>{empPage=p;renderEmpTable();});lucide.createIcons();}
        function filterEmployees(){const q=(document.getElementById('searchEmployee')?.value||'').toLowerCase();filteredEmployees=allEmployees.filter(e=>(e.fullName||e.name).toLowerCase().includes(q)||e.id.toLowerCase().includes(q));empPage=1;renderEmpTable();}
        function filterDashboard(){const q=(document.getElementById('searchDashboard')?.value||'').toLowerCase();if(!q){dashboardRecords=[...allDashboardRecords];}else{dashboardRecords=allDashboardRecords.filter(e=>(e.empName||'').toLowerCase().includes(q)||(e.empId||'').toLowerCase().includes(q)||(e.shift||'').toLowerCase().includes(q)||(e.status||'').toLowerCase().includes(q));}currentPage=1;renderDashTable();}
        
        function handleTitleChange(){const titleSelect=document.getElementById('newEmpTitle');const customGroup=document.getElementById('customTitleGroup');const customInput=document.getElementById('customTitle');if(titleSelect.value==='อื่นๆ'){customGroup.classList.remove('hidden');customInput.required=true;}else{customGroup.classList.add('hidden');customInput.required=false;customInput.value='';}}
        
        function getFiscalYearInfo(){const now=new Date();const currentMonth=now.getMonth();const currentYear=now.getFullYear();let fiscalStartYear,fiscalEndYear;if(currentMonth>=9){fiscalStartYear=currentYear;fiscalEndYear=currentYear+1;}else{fiscalStartYear=currentYear-1;fiscalEndYear=currentYear;}const thaiStartYear=fiscalStartYear+543;const thaiEndYear=fiscalEndYear+543;return{year:thaiEndYear.toString(),startDate:'1 ต.ค. '+thaiStartYear,endDate:'30 ก.ย. '+thaiEndYear};}

        function showEmployeeStats(empId,empName){document.getElementById('employeeStatsModal').classList.add('active');document.getElementById('employeeStatsContent').innerHTML='<div class="stats-loading"><div class="loader-ring"></div><p>กำลังโหลดข้อมูล...</p></div>';lucide.createIcons();loadEmployeeStats(empId,empName);}
        function closeEmployeeStatsModal(){document.getElementById('employeeStatsModal').classList.remove('active');}
        
        async function loadEmployeeStats(empId,empName){try{const r=await callAPI({action:'getEmployeeStats',employeeId:empId});const emp=allEmployees.find(e=>e.id===empId);const avatarChar=emp?getFirstNameChar(emp.name,emp.title):empName.charAt(0).toUpperCase();let stats={totalCheckins:0,totalCheckouts:0,totalLate:0,totalLateMinutes:0};if(r.status==='success'&&r.data){stats=r.data;}const fiscalYear=getFiscalYearInfo();document.getElementById('employeeStatsContent').innerHTML='<div class="emp-stats-header"><div class="emp-stats-avatar">'+avatarChar+'</div><div class="emp-stats-info"><h4>'+empName+'</h4><p>รหัส: '+empId+' | '+(emp?.position||'-')+'</p></div></div><div class="stats-summary"><div class="stat-box green"><div class="stat-num">'+stats.totalCheckins+'</div><div class="stat-txt">เข้างาน (ครั้ง)</div></div><div class="stat-box red"><div class="stat-num">'+stats.totalLate+'</div><div class="stat-txt">มาสาย (ครั้ง)</div></div><div class="stat-box yellow"><div class="stat-num">'+stats.totalCheckouts+'</div><div class="stat-txt">ออกงาน (ครั้ง)</div></div></div><p style="text-align:center;color:var(--text-muted);font-size:0.85rem;margin-bottom:12px">รวมเวลาสาย: <strong style="color:var(--accent-red)">'+stats.totalLateMinutes+'</strong> นาที</p><div class="fiscal-year-info">📊 สถิติปีงบประมาณ <strong>'+fiscalYear.year+'</strong><br>('+fiscalYear.startDate+' - '+fiscalYear.endDate+')</div>';lucide.createIcons();}catch(e){document.getElementById('employeeStatsContent').innerHTML='<div class="empty-state"><i data-lucide="alert-circle"></i><p>ไม่สามารถโหลดข้อมูลได้</p></div>';lucide.createIcons();}}

        function showExportModal(){const today=new Date();const firstDay=new Date(today.getFullYear(),today.getMonth(),1);document.getElementById('exportStartDate').value=firstDay.toISOString().split('T')[0];document.getElementById('exportEndDate').value=today.toISOString().split('T')[0];document.getElementById('exportModal').classList.add('active');lucide.createIcons();}
        function closeExportModal(){document.getElementById('exportModal').classList.remove('active');}
        
        function formatTimeForExcel(rawTime){if(!rawTime||rawTime==='-')return'-';if(typeof rawTime==='string'){if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(rawTime))return rawTime;if(rawTime.includes('GMT')||rawTime.includes('T')){try{const d=new Date(rawTime);if(!isNaN(d.getTime())){const h=String(d.getHours()).padStart(2,'0');const m=String(d.getMinutes()).padStart(2,'0');const s=String(d.getSeconds()).padStart(2,'0');return h+':'+m+':'+s;}}catch(e){return String(rawTime);}}}if(rawTime instanceof Date){const h=String(rawTime.getHours()).padStart(2,'0');const m=String(rawTime.getMinutes()).padStart(2,'0');const s=String(rawTime.getSeconds()).padStart(2,'0');return h+':'+m+':'+s;}return String(rawTime);}
        
        async function exportToExcel(){const startDate=document.getElementById('exportStartDate').value;const endDate=document.getElementById('exportEndDate').value;if(!startDate||!endDate){showResult('error','ไม่สำเร็จ','กรุณาเลือกช่วงวันที่');return;}if(new Date(startDate)>new Date(endDate)){showResult('error','ไม่สำเร็จ','วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด');return;}const btn=document.getElementById('btnDoExport');const orig=btn.innerHTML;btn.innerHTML=spinnerSVG+' กำลังโหลด...';btn.disabled=true;try{const startDateThai=formatDateThai(startDate);const endDateThai=formatDateThai(endDate);const response=await callAPI({action:'getAttendanceRange',startDate:startDateThai,endDate:endDateThai});if(response.status!=='success'){showResult('error','ไม่สำเร็จ','ไม่สามารถโหลดข้อมูลได้');return;}if(!response.data||response.data.length===0){showResult('warning','ไม่พบข้อมูล','ไม่มีข้อมูลการลงเวลาในช่วงวันที่ที่เลือก');return;}const allData=response.data.map(r=>({'วันที่':r.date,'รหัสพนักงาน':r.employeeId,'ชื่อ-สกุล':r.employeeName,'ประเภท':r.type,'ผลัด':r.shift||'-','เวลา':formatTimeForExcel(r.time),'สถานะ':r.status||'ปกติ','สายกี่นาที':r.lateMinutes||0}));const ws=XLSX.utils.json_to_sheet(allData);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'ข้อมูลการลงเวลา');ws['!cols']=[{wch:12},{wch:12},{wch:25},{wch:10},{wch:12},{wch:10},{wch:10},{wch:10}];const fileName='attendance_'+startDate+'_to_'+endDate+'.xlsx';XLSX.writeFile(wb,fileName);closeExportModal();showResult('success','สำเร็จ','ดาวน์โหลดไฟล์ '+fileName+' เรียบร้อย');}catch(error){console.error('Export error:',error);showResult('error','ไม่สำเร็จ','เกิดข้อผิดพลาดในการสร้างไฟล์');}finally{btn.innerHTML=orig;btn.disabled=false;lucide.createIcons();}}
        function formatDateThai(dateStr){const[y,m,d]=dateStr.split('-');return d+'/'+m+'/'+y;}

        function populateRegSelect(){const s=document.getElementById('regEmployeeSelect');s.innerHTML='<option value="">-- เลือกพนักงาน --</option>';allEmployees.forEach(e=>{const o=document.createElement('option');o.value=e.id;o.textContent=e.id+' - '+(e.fullName||e.name)+(e.hasFaceData?' (ลงทะเบียนแล้ว)':'');s.appendChild(o);});}
        function renderPagination(containerId,total,current,onChange){const c=document.getElementById(containerId);if(total<=1){c.innerHTML='';return;}let h='<button '+(current===1?'disabled':'')+' data-page="'+(current-1)+'"><i data-lucide="chevron-left"></i></button>';for(let i=1;i<=total;i++){if(i===1||i===total||(i>=current-1&&i<=current+1))h+='<button class="'+(i===current?'active':'')+'" data-page="'+i+'">'+i+'</button>';else if(i===current-2||i===current+2)h+='<span class="pagination-info">...</span>';}h+='<span class="pagination-info">'+total+' หน้า</span>';h+='<button '+(current===total?'disabled':'')+' data-page="'+(current+1)+'"><i data-lucide="chevron-right"></i></button>';c.innerHTML=h;c.querySelectorAll('button[data-page]').forEach(btn=>{btn.addEventListener('click',()=>{const p=parseInt(btn.dataset.page);if(p>=1&&p<=total)onChange(p);});});lucide.createIcons();}

        function updateDateTime(){const n=new Date();document.getElementById('currentTime').textContent=n.toLocaleTimeString('th-TH',{hour12:false});document.getElementById('currentDate').textContent=n.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});}
        function isPointInPolygon(lat,lng,poly){let inside=false;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const xi=poly[i].lat,yi=poly[i].lng,xj=poly[j].lat,yj=poly[j].lng;if(((yi>lng)!==(yj>lng))&&(lat<(xj-xi)*(lng-yi)/(yj-yi)+xi))inside=!inside;}return inside;}
        function isInAnyWorkArea(lat,lng){for(let i=0;i<WORK_AREAS.length;i++)if(isPointInPolygon(lat,lng,WORK_AREAS[i]))return{valid:true,area:i+1};return{valid:false,area:-1};}

        async function startCamera(){try{videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}});const v=document.getElementById('video');v.srcObject=videoStream;v.onloadedmetadata=()=>{v.play();document.getElementById('cameraPlaceholder').style.display='none';const cv=document.getElementById('overlayCanvas');cv.width=v.videoWidth;cv.height=v.videoHeight;};}catch(e){document.getElementById('cameraPlaceholder').innerHTML='<i data-lucide="camera-off"></i><p>เปิดกล้องไม่ได้</p>';lucide.createIcons();}}
        function startDetection(){if(detectionInterval)clearInterval(detectionInterval);detectionInterval=setInterval(async()=>{if(isDetecting)return;const v=document.getElementById('video');if(!v||v.paused||v.ended)return;isDetecting=true;await detectFace();isDetecting=false;},300);}

        async function detectFace(){const v=document.getElementById('video'),c=document.getElementById('overlayCanvas');try{const d=await faceapi.detectSingleFace(v,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);if(!d){updateFaceStatus('face','กำลังค้นหาใบหน้า...');matchedEmployee=null;faceDescriptor=null;document.getElementById('matchedSection').classList.add('hidden');checkBtns();return;}faceDescriptor=d.descriptor;const box=d.detection.box,sx=c.width/v.videoWidth,sy=c.height/v.videoHeight;let best=null,bestD=1;for(const e of employees){if(!e.faceDescriptor)continue;const dist=faceapi.euclideanDistance(d.descriptor,new Float32Array(e.faceDescriptor));if(dist<bestD&&dist<FACE_MATCH_THRESHOLD){bestD=dist;best=e;}}ctx.strokeStyle=best?'#10b981':'#ef4444';ctx.lineWidth=4;ctx.strokeRect(box.x*sx,box.y*sy,box.width*sx,box.height*sy);if(best){matchedEmployee=best;matchedEmployee.faceDistance=bestD;const conf=((1-bestD)*100).toFixed(1);const avatarChar=getFirstNameChar(best.name,best.title);updateFaceStatus('matched',best.fullName||best.name);document.getElementById('matchedSection').classList.remove('hidden');document.getElementById('matchedName').textContent=best.fullName||best.name;document.getElementById('matchedPosition').textContent=best.id+' | '+(best.position||'-');document.getElementById('matchConfidence').textContent=conf+'%';document.getElementById('matchedAvatar').textContent=avatarChar;}else{matchedEmployee=null;updateFaceStatus('face','ไม่พบข้อมูลใบหน้า');document.getElementById('matchedSection').classList.add('hidden');}checkBtns();}catch(e){}}
        function updateFaceStatus(s,m){const el=document.getElementById('faceStatus');el.className='status-card '+(s==='matched'?'matched':'');el.innerHTML='<i data-lucide="'+(s==='matched'?'smile':'scan-face')+'"></i><span>'+m+'</span>';lucide.createIcons();}
        function checkBtns(){const ok=matchedEmployee&&selectedShift;document.getElementById('btnCheckIn').disabled=!ok;document.getElementById('btnCheckOut').disabled=!ok;}

        async function recordAtt(action){if(!matchedEmployee||!selectedShift)return;const btn=document.getElementById(action==='checkIn'?'btnCheckIn':'btnCheckOut');const orig=btn.innerHTML;btn.innerHTML=spinnerSVG+' กำลังตรวจสอบ...';btn.disabled=true;try{await refreshGPS();}catch(e){showResult('error','ไม่พบ GPS','กรุณาเปิด GPS และอนุญาตให้ใช้ตำแหน่ง');btn.innerHTML=orig;btn.disabled=false;lucide.createIcons();checkBtns();return;}const area=isInAnyWorkArea(currentLocation.latitude,currentLocation.longitude);if(!area.valid){showResult('error','นอกพื้นที่ทำงาน','คุณอยู่นอกพื้นที่ที่กำหนด\n\nตำแหน่งปัจจุบัน:\nLat: '+currentLocation.latitude.toFixed(6)+'\nLng: '+currentLocation.longitude.toFixed(6));btn.innerHTML=orig;btn.disabled=false;lucide.createIcons();checkBtns();return;}btn.innerHTML=spinnerSVG+' บันทึก...';try{const photo=capturePhoto(document.getElementById('video'));const now=new Date();const timeStr=now.toLocaleTimeString('th-TH',{hour12:false});const attData={employeeId:matchedEmployee.id,employeeName:matchedEmployee.fullName||matchedEmployee.name,type:action==='checkIn'?'เข้างาน':'ออกงาน',shift:selectedShift,time:timeStr,latitude:currentLocation.latitude,longitude:currentLocation.longitude,areaIndex:area.area,faceConfidence:((1-matchedEmployee.faceDistance)*100).toFixed(1)+'%',timestamp:now.toISOString(),status:'pending'};const fbResult=await firebasePush('pendingAttendance',attData);const t=action==='checkIn'?'เข้างาน':'ออกงาน';showResult('success','บันทึก'+t+'สำเร็จ',(matchedEmployee.fullName||matchedEmployee.name)+'\nผลัด: '+selectedShift+'\nเวลา: '+timeStr+'\nพื้นที่: '+area.area);callAPI({action:action,employeeId:matchedEmployee.id,employeeName:matchedEmployee.fullName||matchedEmployee.name,latitude:currentLocation.latitude,longitude:currentLocation.longitude,faceVerified:true,faceConfidence:1-matchedEmployee.faceDistance,shift:selectedShift,photoBase64:photo}).then(r=>{if(r.status==='success'&&fbResult&&fbResult.name)firebaseDelete('pendingAttendance/'+fbResult.name);}).catch(e=>{console.error('Sync failed:',e);});}catch(e){showResult('error','เกิดข้อผิดพลาด','เชื่อมต่อเซิร์ฟเวอร์ไม่ได้');}finally{btn.innerHTML=orig;lucide.createIcons();checkBtns();}}

        function toggleSidebar(){document.getElementById('sidebar').classList.toggle('active');document.getElementById('sidebarOverlay').classList.toggle('active');lucide.createIcons();}
        function closeSidebar(){document.getElementById('sidebar').classList.remove('active');document.getElementById('sidebarOverlay').classList.remove('active');}
        function isMobile(){return window.innerWidth<=1024;}
        function navigateTo(pageId){showPage(pageId);if(isMobile())closeSidebar();}
        function updateSidebarActive(pageId){document.querySelectorAll('.sidebar-nav-btn[data-page]').forEach(btn=>{btn.classList.toggle('active',btn.dataset.page===pageId);});}
        function updateSidebarUser(){if(currentUser){const firstChar=(currentUser.name||currentUser.username||'A').charAt(0).toUpperCase();document.getElementById('sidebarAvatar').textContent=firstChar;document.getElementById('sidebarUsername').textContent=currentUser.name||currentUser.username;document.getElementById('sidebarRole').textContent=currentUser.role==='admin'?'ผู้ดูแลระบบ':'ผู้ใช้งาน';document.getElementById('adminAvatarBtn').textContent=firstChar;document.getElementById('dashAvatarBtn').textContent=firstChar;const editlogBtn=document.getElementById('editlogAvatarBtn');if(editlogBtn)editlogBtn.textContent=firstChar;const usersBtn=document.getElementById('usersAvatarBtn');if(usersBtn)usersBtn.textContent=firstChar;const menuUsers=document.getElementById('menuUsers');if(menuUsers)menuUsers.style.display=currentUser.role==='admin'?'flex':'none';}}

        function showLoginModal(){document.getElementById('loginModal').classList.add('active');lucide.createIcons();}
        function closeLoginModal(){document.getElementById('loginModal').classList.remove('active');}
        async function handleLogin(e){e.preventDefault();const u=document.getElementById('loginUsername').value,p=document.getElementById('loginPassword').value;const btn=e.target.querySelector('button[type="submit"]'),orig=btn.innerHTML;btn.innerHTML=spinnerSVG+' เข้าสู่ระบบ...';btn.disabled=true;try{const r=await callAPI({action:'login',username:u,password:p});if(r.status==='success'){currentUser=r.data;localStorage.setItem('currentUser',JSON.stringify(currentUser));updateSidebarUser();closeLoginModal();showPage('pageDashboard');}else{showResult('error','ไม่สำเร็จ',r.message);}}catch(e){showResult('error','เกิดข้อผิดพลาด','เชื่อมต่อไม่ได้');}finally{btn.innerHTML=orig;btn.disabled=false;lucide.createIcons();}}
        function logout(){currentUser=null;localStorage.removeItem('currentUser');localStorage.removeItem('currentPage');closeSidebar();showPage('pageAttendance');}

        // Edit Employee Modal
        function showEditEmployeeModal(empId){
            const emp=allEmployees.find(e=>e.id===empId);
            if(!emp)return;
            document.getElementById('editEmpIdHidden').value=empId;
            document.getElementById('editEmpId').value=empId;
            document.getElementById('editEmpTitle').value=emp.title||'';
            document.getElementById('editEmpName').value=emp.name||'';
            document.getElementById('editEmpPosition').value=emp.position||'';
            document.getElementById('editEmpGroup').value=emp.group||'';
            document.getElementById('editEmployeeModal').classList.add('active');
            lucide.createIcons();
        }
        function closeEditEmployeeModal(){document.getElementById('editEmployeeModal').classList.remove('active');}
        document.getElementById('editEmployeeForm')?.addEventListener('submit',async e=>{
            e.preventDefault();
            const empId=document.getElementById('editEmpIdHidden').value;
            const emp=allEmployees.find(e=>e.id===empId);
            const oldData={title:emp?.title||'',name:emp?.name||'',position:emp?.position||'',group:emp?.group||''};
            const data={id:empId,title:document.getElementById('editEmpTitle').value,name:document.getElementById('editEmpName').value,position:document.getElementById('editEmpPosition').value,group:document.getElementById('editEmpGroup').value};
            const btn=e.target.querySelector('button[type=submit]');
            btn.innerHTML=spinnerSVG+' บันทึก...';btn.disabled=true;
            const r=await callAPI({action:'editEmployee',...data,oldData:JSON.stringify(oldData),editor:currentUser?.name||'Admin'});
            btn.innerHTML='<i data-lucide="save"></i>บันทึกการแก้ไข';btn.disabled=false;lucide.createIcons();
            if(r.status==='success'){closeEditEmployeeModal();showResult('success','สำเร็จ','แก้ไขข้อมูลพนักงานเรียบร้อย');loadEmployees();}
            else{showResult('error','ไม่สำเร็จ',r.message||'เกิดข้อผิดพลาด');}
        });

        // Delete Employee
        async function deleteEmployee(empId){
            if(!confirm('ยืนยันลบพนักงาน '+empId+' ?'))return;
            const r=await callAPI({action:'deleteEmployee',employeeId:empId,editor:currentUser?.name||'Admin'});
            if(r.status==='success'){showResult('success','สำเร็จ','ลบพนักงานเรียบร้อย');loadEmployees();}
            else{showResult('error','ไม่สำเร็จ',r.message||'เกิดข้อผิดพลาด');}
        }

        // Edit User Modal
        function showEditUserModal(){
            if(!currentUser)return;
            document.getElementById('editUsername').value=currentUser.username||'';
            document.getElementById('editDisplayName').value=currentUser.name||'';
            document.getElementById('editOldPassword').value='';
            document.getElementById('editNewPassword').value='';
            document.getElementById('editUserModal').classList.add('active');
            closeSidebar();
            lucide.createIcons();
        }
        function closeEditUserModal(){document.getElementById('editUserModal').classList.remove('active');}
        document.getElementById('editUserForm')?.addEventListener('submit',async e=>{
            e.preventDefault();
            const data={username:document.getElementById('editUsername').value,oldPassword:document.getElementById('editOldPassword').value,newPassword:document.getElementById('editNewPassword').value,displayName:document.getElementById('editDisplayName').value};
            const btn=e.target.querySelector('button[type=submit]');
            btn.innerHTML=spinnerSVG+' บันทึก...';btn.disabled=true;
            const r=await callAPI({action:'updateUser',...data,editor:currentUser?.name||'Admin'});
            btn.innerHTML='<i data-lucide="save"></i>บันทึก';btn.disabled=false;lucide.createIcons();
            if(r.status==='success'){closeEditUserModal();currentUser.name=data.displayName;document.getElementById('sidebarUsername').textContent=data.displayName;localStorage.setItem('currentUser',JSON.stringify(currentUser));showResult('success','สำเร็จ','แก้ไขบัญชีเรียบร้อย');}
            else{showResult('error','ไม่สำเร็จ',r.message||'เกิดข้อผิดพลาด');}
        });

        // Toggle Password Visibility
        function togglePassword(inputId, btn){
            const input=document.getElementById(inputId);
            const icon=btn.querySelector('i');
            if(input.type==='password'){input.type='text';icon.setAttribute('data-lucide','eye-off');}
            else{input.type='password';icon.setAttribute('data-lucide','eye');}
            lucide.createIcons();
        }

        // Add User Modal
        function showAddUserModal(){
            document.getElementById('newUsername').value='';
            document.getElementById('newUserPassword').value='';
            document.getElementById('newDisplayName').value='';
            document.getElementById('newUserRole').value='admin';
            document.getElementById('addUserModal').classList.add('active');
            closeSidebar();
            lucide.createIcons();
        }
        function closeAddUserModal(){document.getElementById('addUserModal').classList.remove('active');}
        document.getElementById('addUserForm')?.addEventListener('submit',async e=>{
            e.preventDefault();
            const data={username:document.getElementById('newUsername').value,password:document.getElementById('newUserPassword').value,displayName:document.getElementById('newDisplayName').value,role:document.getElementById('newUserRole').value};
            const btn=e.target.querySelector('button[type=submit]');
            btn.innerHTML=spinnerSVG+' เพิ่ม...';btn.disabled=true;
            const r=await callAPI({action:'addUser',...data,editor:currentUser?.name||'Admin'});
            btn.innerHTML='<i data-lucide="user-plus"></i>เพิ่มผู้ใช้';btn.disabled=false;lucide.createIcons();
            if(r.status==='success'){closeAddUserModal();showResult('success','สำเร็จ','เพิ่มผู้ใช้เรียบร้อย');}
            else{showResult('error','ไม่สำเร็จ',r.message||'เกิดข้อผิดพลาด');}
        });

        // Edit Log
        let editLogRecords=[],allEditLogRecords=[],editLogPage=1;
        async function loadEditLogs(){
            try{
                const r=await callAPI({action:'getEditLogs'});
                if(r.status==='success'){allEditLogRecords=r.data||[];editLogRecords=[...allEditLogRecords];editLogPage=1;renderEditLogTable();}
            }catch(e){console.error(e);}
        }
        function renderEditLogTable(){
            const tbody=document.getElementById('editLogTableBody');
            const total=Math.ceil(editLogRecords.length/ITEMS_PER_PAGE);
            const start=(editLogPage-1)*ITEMS_PER_PAGE;
            const pageData=editLogRecords.slice(start,start+ITEMS_PER_PAGE);
            if(!editLogRecords.length){tbody.innerHTML='<tr><td colspan="5" class="empty-state"><i data-lucide="inbox"></i><p>ไม่มีข้อมูล</p></td></tr>';document.getElementById('editLogPagination').innerHTML='';lucide.createIcons();return;}
            tbody.innerHTML=pageData.map(r=>{
                let badgeClass='info';
                if(r.type.includes('ลบ'))badgeClass='danger';
                else if(r.type.includes('เพิ่ม'))badgeClass='success';
                else if(r.type.includes('แก้ไข'))badgeClass='warning';
                return '<tr><td style="white-space:nowrap">'+r.timestamp+'</td><td>'+r.editor+'</td><td><span class="badge '+badgeClass+'">'+r.type+'</span></td><td>'+r.targetId+'</td><td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">'+(r.detail||'-')+'</td></tr>';
            }).join('');
            renderPagination('editLogPagination',total,editLogPage,p=>{editLogPage=p;renderEditLogTable();});
            lucide.createIcons();
        }
        function filterEditLogs(){
            const q=(document.getElementById('searchEditLog')?.value||'').toLowerCase();
            if(!q){editLogRecords=[...allEditLogRecords];}
            else{editLogRecords=allEditLogRecords.filter(r=>(r.timestamp||'').toLowerCase().includes(q)||(r.editor||'').toLowerCase().includes(q)||(r.type||'').toLowerCase().includes(q)||(r.targetId||'').toLowerCase().includes(q));}
            editLogPage=1;renderEditLogTable();
        }

        // Users Management
        let usersRecords=[],allUsersRecords=[],usersPage=1;
        async function loadUsers(){
            try{
                const r=await callAPI({action:'getUsers'});
                if(r.status==='success'){allUsersRecords=r.data||[];usersRecords=[...allUsersRecords];usersPage=1;renderUsersTable();}
            }catch(e){console.error(e);}
        }
        function renderUsersTable(){
            const tbody=document.getElementById('usersTableBody');
            const total=Math.ceil(usersRecords.length/ITEMS_PER_PAGE);
            const start=(usersPage-1)*ITEMS_PER_PAGE;
            const pageData=usersRecords.slice(start,start+ITEMS_PER_PAGE);
            if(!usersRecords.length){tbody.innerHTML='<tr><td colspan="4" class="empty-state"><i data-lucide="inbox"></i><p>ไม่มีข้อมูล</p></td></tr>';document.getElementById('usersPagination').innerHTML='';lucide.createIcons();return;}
            tbody.innerHTML=pageData.map(u=>{
                const firstChar=(u.name||u.username||'?').charAt(0).toUpperCase();
                return '<tr><td><div class="emp-cell"><div class="emp-avatar">'+firstChar+'</div><div><div class="emp-name">'+u.username+'</div></div></div></td><td>'+u.name+'</td><td><span class="badge '+(u.role==='admin'?'info':'secondary')+'">'+u.role+'</span></td><td><div class="action-btns"><button class="btn btn-icon danger" onclick="deleteUser(\''+u.username+'\')"><i data-lucide="trash-2"></i></button></div></td></tr>';
            }).join('');
            renderPagination('usersPagination',total,usersPage,p=>{usersPage=p;renderUsersTable();});
            lucide.createIcons();
        }
        function filterUsers(){
            const q=(document.getElementById('searchUsers')?.value||'').toLowerCase();
            if(!q){usersRecords=[...allUsersRecords];}
            else{usersRecords=allUsersRecords.filter(u=>(u.username||'').toLowerCase().includes(q)||(u.name||'').toLowerCase().includes(q)||(u.role||'').toLowerCase().includes(q));}
            usersPage=1;renderUsersTable();
        }
        async function deleteUser(username){
            if(username===currentUser?.username){showResult('error','ไม่สำเร็จ','ไม่สามารถลบบัญชีตัวเองได้');return;}
            if(!confirm('ยืนยันลบผู้ใช้ '+username+' ?'))return;
            const r=await callAPI({action:'deleteUser',username:username,editor:currentUser?.name||'Admin'});
            if(r.status==='success'){showResult('success','สำเร็จ','ลบผู้ใช้เรียบร้อย');loadUsers();}
            else{showResult('error','ไม่สำเร็จ',r.message||'เกิดข้อผิดพลาด');}
        }

        // Camera Switch
        let useFrontCamera=true;
        async function switchCamera(){
            useFrontCamera=!useFrontCamera;
            if(regVideoStream){regVideoStream.getTracks().forEach(t=>t.stop());}
            try{
                regVideoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:useFrontCamera?'user':'environment',width:{ideal:640},height:{ideal:480}}});
                document.getElementById('regVideo').srcObject=regVideoStream;
            }catch(e){console.error('Camera switch error:',e);showResult('error','ไม่สำเร็จ','ไม่สามารถสลับกล้องได้');}
        }

        function showPage(id,save=true){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');if(save)localStorage.setItem('currentPage',id);if(id==='pageDashboard'){setToday();}else if(id==='pageEditLog'){loadEditLogs();}else if(id==='pageUsers'){loadUsers();}else if(id==='pageAdmin'){renderEmpTable();}else{stopAutoRefresh();}if(id!=='pageAdmin')stopRegCam();updateSidebarActive(id);lucide.createIcons();}

        function showAddEmployeeModal(){document.getElementById('addEmployeeModal').classList.add('active');document.getElementById('customTitleGroup').classList.add('hidden');document.getElementById('customTitle').value='';document.getElementById('newEmpTitle').value='';loadNextId();lucide.createIcons();}
        function closeAddEmployeeModal(){document.getElementById('addEmployeeModal').classList.remove('active');}
        async function handleAddEmp(e){e.preventDefault();const btn=e.target.querySelector('button[type="submit"]'),orig=btn.innerHTML;let title=document.getElementById('newEmpTitle').value;if(title==='อื่นๆ'){title=document.getElementById('customTitle').value.trim();if(!title){showResult('error','ไม่สำเร็จ','กรุณาระบุคำนำหน้า');return;}}btn.innerHTML=spinnerSVG+' บันทึก...';btn.disabled=true;const data={action:'addEmployee',id:document.getElementById('newEmpId').value.trim(),title:title,name:document.getElementById('newEmpName').value.trim(),position:document.getElementById('newEmpPosition').value.trim(),group:document.getElementById('newEmpGroup').value.trim()};try{const empData={id:data.id,title:data.title||'',name:data.name,fullName:(data.title||'')+data.name,position:data.position||'-',group:data.group||'-',createdAt:new Date().toISOString(),status:'pending'};await firebasePush('pendingEmployees',empData);const r=await callAPI(data);if(r.status==='success'){showResult('success','สำเร็จ',r.message);document.getElementById('newEmpTitle').value='';document.getElementById('newEmpName').value='';document.getElementById('newEmpPosition').value='';document.getElementById('newEmpGroup').value='';document.getElementById('customTitleGroup').classList.add('hidden');document.getElementById('customTitle').value='';closeAddEmployeeModal();await loadEmployees();}else{showResult('error','ไม่สำเร็จ',r.message);}}catch(e){showResult('error','เกิดข้อผิดพลาด','เชื่อมต่อไม่ได้');}finally{btn.innerHTML=orig;btn.disabled=false;lucide.createIcons();}}

        function selectForReg(id){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelector('[data-tab="register-face"]').classList.add('active');document.getElementById('tab-register-face').classList.add('active');document.getElementById('regEmployeeSelect').value=id;handleRegChange();lucide.createIcons();}
        async function handleRegChange(){const id=document.getElementById('regEmployeeSelect').value;if(id){selectedRegEmployee=allEmployees.find(e=>e.id===id);showSelEmp();await startRegCam();startRegDetection();}else{selectedRegEmployee=null;hideSelEmp();stopRegCam();}}
        function showSelEmp(){const avatarChar=getFirstNameChar(selectedRegEmployee.name,selectedRegEmployee.title);document.getElementById('selectedEmployee').classList.remove('hidden');document.getElementById('selectedName').textContent=selectedRegEmployee.fullName||selectedRegEmployee.name;document.getElementById('selectedPosition').textContent=(selectedRegEmployee.position||'-')+' | '+(selectedRegEmployee.group||'-');document.getElementById('selectedAvatar').textContent=avatarChar;document.getElementById('currentFaceStatus').classList.remove('hidden');document.getElementById('faceRegistrationStatus').innerHTML=selectedRegEmployee.hasFaceData?'<span class="badge success">ลงทะเบียนแล้ว</span>':'<span class="badge warning">ยังไม่ลงทะเบียน</span>';lucide.createIcons();}
        function hideSelEmp(){document.getElementById('selectedEmployee').classList.add('hidden');document.getElementById('currentFaceStatus').classList.add('hidden');}
        async function startRegCam(){try{regVideoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}});const v=document.getElementById('regVideo');v.srcObject=regVideoStream;v.onloadedmetadata=()=>{v.play();document.getElementById('regPlaceholder').style.display='none';const cv=document.getElementById('regCanvas');cv.width=v.videoWidth;cv.height=v.videoHeight;};}catch(e){}}
        function stopRegCam(){if(regDetectionInterval){clearInterval(regDetectionInterval);regDetectionInterval=null;}if(regVideoStream){regVideoStream.getTracks().forEach(t=>t.stop());regVideoStream=null;}const v=document.getElementById('regVideo');if(v)v.srcObject=null;const p=document.getElementById('regPlaceholder');if(p){p.style.display='flex';p.innerHTML='<i data-lucide="camera"></i><p>เลือกพนักงาน</p>';}regFaceDescriptor=null;document.getElementById('btnSaveFace').disabled=true;lucide.createIcons();}
        function startRegDetection(){if(regDetectionInterval)clearInterval(regDetectionInterval);regDetectionInterval=setInterval(async()=>{const v=document.getElementById('regVideo');if(!v||v.paused||v.ended||!selectedRegEmployee)return;await detectRegFace();},300);}
        async function detectRegFace(){const v=document.getElementById('regVideo'),c=document.getElementById('regCanvas');try{const d=await faceapi.detectSingleFace(v,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);if(!d){updateRegStatus('detecting','ไม่พบใบหน้า');regFaceDescriptor=null;document.getElementById('btnSaveFace').disabled=true;return;}regFaceDescriptor=d.descriptor;const box=d.detection.box,sx=c.width/v.videoWidth,sy=c.height/v.videoHeight;ctx.strokeStyle='#10b981';ctx.lineWidth=4;ctx.strokeRect(box.x*sx,box.y*sy,box.width*sx,box.height*sy);updateRegStatus('detected','พร้อมบันทึก');document.getElementById('btnSaveFace').disabled=false;}catch(e){}}
        function updateRegStatus(s,m){const el=document.getElementById('regFaceStatus');el.className='face-status '+s;el.innerHTML='<i data-lucide="'+(s==='detected'?'smile':'scan-face')+'"></i><span>'+m+'</span>';lucide.createIcons();}

        async function saveFace(){if(!regFaceDescriptor||!selectedRegEmployee)return;const btn=document.getElementById('btnSaveFace');btn.disabled=true;btn.innerHTML=spinnerSVG+' บันทึก...';try{const photo=capturePhoto(document.getElementById('regVideo'));const now=new Date();await firebaseSet('faceData/'+selectedRegEmployee.id,{employeeId:selectedRegEmployee.id,descriptor:Array.from(regFaceDescriptor),registeredAt:now.toISOString(),updatedAt:now.toISOString()});showResult('success','สำเร็จ','บันทึกข้อมูลใบหน้าสำเร็จ');await loadEmployees();selectedRegEmployee=allEmployees.find(e=>e.id===selectedRegEmployee.id);showSelEmp();callAPI({action:'registerFace',employeeId:selectedRegEmployee.id,faceDescriptor:Array.from(regFaceDescriptor),photoBase64:photo}).catch(e=>{console.error('Sync face failed:',e);});}catch(e){showResult('error','เกิดข้อผิดพลาด','เชื่อมต่อไม่ได้');}finally{btn.disabled=false;btn.innerHTML='<i data-lucide="save"></i>บันทึกใบหน้า';lucide.createIcons();}}
        async function deleteFace(id){if(!confirm('ลบข้อมูลใบหน้า?'))return;try{await firebaseDelete('faceData/'+id);const r=await callAPI({action:'deleteFace',employeeId:id});if(r.status==='success'){showResult('success','สำเร็จ',r.message);await loadEmployees();}else{showResult('error','ไม่สำเร็จ',r.message);}}catch(e){showResult('error','เกิดข้อผิดพลาด','เชื่อมต่อไม่ได้');}}

        function setToday(){const t=new Date();const dateStr=t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0')+'-'+String(t.getDate()).padStart(2,'0');document.getElementById('dashboardDate').value=dateStr;userSelectedDate=dateStr;loadDashboard();startAutoRefresh();}
        
        let dashboardRefreshInterval=null;
        function startAutoRefresh(){if(dashboardRefreshInterval)clearInterval(dashboardRefreshInterval);dashboardRefreshInterval=setInterval(()=>{const currentPageEl=document.querySelector('.page.active');if(currentPageEl&&currentPageEl.id==='pageDashboard'){loadDashboard();}},5*60*1000);}
        function stopAutoRefresh(){if(dashboardRefreshInterval){clearInterval(dashboardRefreshInterval);dashboardRefreshInterval=null;}}
        function updateLastUpdateTime(){const now=new Date();const timeStr=now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit'});const el=document.getElementById('lastUpdateTime');if(el)el.textContent=timeStr;}
        
        async function loadDashboard(){const dt=document.getElementById('dashboardDate').value;if(!dt)return;userSelectedDate=dt;const btnL=document.getElementById('btnLoadDash'),btnT=document.getElementById('btnToday');const origL=btnL.innerHTML,origT=btnT.innerHTML;btnL.innerHTML=spinnerSVG+' โหลด...';btnL.disabled=true;btnT.disabled=true;const parts=dt.split('-'),dateStr=parts[2]+'/'+parts[1]+'/'+parts[0];try{const empR=await callAPI({action:'getEmployees'});document.getElementById('statTotal').textContent=empR.data?.length||0;const r=await callAPI({action:'getDashboard',date:dateStr});if(r.status==='success'){const data=r.data;const newDataHash=JSON.stringify({c:data.totalCheckins,o:data.totalCheckouts,l:data.totalLate,e:data.employees?.map(e=>e.empId+e.checkInTime+e.checkOutTime).join('')});if(window.lastDashboardHash!==newDataHash){window.lastDashboardHash=newDataHash;document.getElementById('statCheckins').textContent=data.totalCheckins||0;document.getElementById('statCheckouts').textContent=data.totalCheckouts||0;document.getElementById('statLate').textContent=data.totalLate||0;renderCharts(data);allDashboardRecords=data.employees||[];dashboardRecords=[...allDashboardRecords];document.getElementById('searchDashboard').value='';currentPage=1;renderDashTable();}updateLastUpdateTime();}}catch(e){}finally{btnL.innerHTML=origL;btnL.disabled=false;btnT.disabled=false;lucide.createIcons();}}

        function renderCharts(data){const byShift=data.byShift||{};const sCtx=document.getElementById('shiftChart').getContext('2d');if(shiftChart)shiftChart.destroy();shiftChart=new Chart(sCtx,{type:'doughnut',data:{labels:Object.keys(byShift),datasets:[{data:Object.values(byShift).map(s=>s.checkins||0),backgroundColor:['#10b981','#3b82f6','#f59e0b','#8b5cf6'],borderWidth:0,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#94a3b8',padding:16,font:{family:'Kanit'}}}}}});const stCtx=document.getElementById('statusChart').getContext('2d');if(statusChart)statusChart.destroy();statusChart=new Chart(stCtx,{type:'bar',data:{labels:['เข้างานปกติ','มาสาย','ออกงานแล้ว'],datasets:[{data:[(data.totalCheckins||0)-(data.totalLate||0),data.totalLate||0,data.totalCheckouts||0],backgroundColor:['#10b981','#ef4444','#3b82f6'],borderRadius:8,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,color:'#94a3b8',font:{family:'Kanit'}},grid:{color:'rgba(99,115,148,0.1)'}},x:{ticks:{color:'#94a3b8',font:{family:'Kanit'}},grid:{display:false}}}}});}

        function formatTime(rawTime){if(!rawTime||rawTime==='-')return'-';if(typeof rawTime==='string'){if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(rawTime))return rawTime;if(rawTime.includes('GMT')||rawTime.includes('T')){try{const d=new Date(rawTime);if(!isNaN(d.getTime())){return d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});}}catch(e){return String(rawTime);}}}if(rawTime instanceof Date){return rawTime.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});}return String(rawTime);}
        function renderDashTable(){const tbody=document.getElementById('dashboardTable');const total=Math.ceil(dashboardRecords.length/ITEMS_PER_PAGE);const start=(currentPage-1)*ITEMS_PER_PAGE;const pageRecs=dashboardRecords.slice(start,start+ITEMS_PER_PAGE);if(!dashboardRecords.length){tbody.innerHTML='<tr><td colspan="7" class="empty-state"><i data-lucide="inbox"></i><p>ไม่มีข้อมูล</p></td></tr>';document.getElementById('dashPagination').innerHTML='';lucide.createIcons();return;}const convertUrl=u=>{if(!u)return'';if(u.includes('drive.google.com/uc?export=view&id='))return'https://lh3.googleusercontent.com/d/'+u.split('id=')[1];return u;};tbody.innerHTML=pageRecs.map(e=>{const late=e.status==='สาย';const cls=late?'class="late-row"':'';const inP=convertUrl(e.checkInPhoto),outP=convertUrl(e.checkOutPhoto);const avatarChar=e.empName?e.empName.replace(/^(นาย|นาง|นางสาว)/,'').trim().charAt(0).toUpperCase():'?';const checkInFormatted=formatTime(e.checkInTime);const checkOutFormatted=formatTime(e.checkOutTime);return '<tr '+cls+'><td><div class="emp-cell"><div class="emp-avatar" style="background:'+(late?'linear-gradient(135deg,#ef4444,#dc2626)':'linear-gradient(135deg,#10b981,#059669)')+'">'+avatarChar+'</div><div><div class="emp-name" style="'+(late?'color:#ef4444':'')+'">'+e.empName+'</div><div class="emp-id">'+e.empId+'</div></div></div></td><td>'+(e.shift||'-')+'</td><td style="font-weight:600;color:#10b981">'+checkInFormatted+'</td><td>'+(inP?'<img src="'+inP+'" class="photo-thumb" onclick="showImg(\''+inP+'\')" onerror="this.outerHTML=\'-\'">':'-')+'</td><td style="font-weight:600;color:#ef4444">'+checkOutFormatted+'</td><td>'+(outP?'<img src="'+outP+'" class="photo-thumb" onclick="showImg(\''+outP+'\')" onerror="this.outerHTML=\'-\'">':'-')+'</td><td><span class="badge '+(late?'danger':'success')+'">'+(late?'สาย ('+e.lateMinutes+' นาที)':'ปกติ')+'</span></td></tr>';}).join('');renderPagination('dashPagination',total,currentPage,p=>{currentPage=p;renderDashTable();});lucide.createIcons();}

        function showImg(url){document.getElementById('previewImage').src=url;document.getElementById('imageModal').classList.add('active');lucide.createIcons();}
        function closeImageModal(){document.getElementById('imageModal').classList.remove('active');}
        function showResult(type,title,msg){const m=document.getElementById('resultModal'),icon=document.getElementById('resultIcon');icon.className='modal-icon '+type;icon.innerHTML='<i data-lucide="'+(type==='success'?'check':type==='error'?'x':'alert-triangle')+'"></i>';document.getElementById('resultTitle').textContent=title;document.getElementById('resultMessage').textContent=msg;m.classList.add('active');lucide.createIcons();}
        function closeResultModal(){document.getElementById('resultModal').classList.remove('active');}
        document.getElementById('resultModal').addEventListener('click',e=>{if(e.target.id==='resultModal')closeResultModal();});
        document.getElementById('loginModal').addEventListener('click',e=>{if(e.target.id==='loginModal')closeLoginModal();});
        document.getElementById('addEmployeeModal').addEventListener('click',e=>{if(e.target.id==='addEmployeeModal')closeAddEmployeeModal();});
        document.getElementById('employeeStatsModal').addEventListener('click',e=>{if(e.target.id==='employeeStatsModal')closeEmployeeStatsModal();});
        document.getElementById('imageModal').addEventListener('click',e=>{if(e.target.id==='imageModal')closeImageModal();});
        document.getElementById('exportModal').addEventListener('click',e=>{if(e.target.id==='exportModal')closeExportModal();});
    </script>
</body>
</html>
