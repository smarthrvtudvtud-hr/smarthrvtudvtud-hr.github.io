<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/100/face-id.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/180/face-id.png">
    <title>ลงเวลาทำงาน (Lite)</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1e293b;
            --bg-card: #151c2c;
            --bg-elevated: #1e2a3a;
            --border: rgba(99, 115, 148, 0.2);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-green: #10b981;
            --accent-green-dark: #059669;
            --accent-green-bg: rgba(16, 185, 129, 0.12);
            --accent-green-glow: rgba(16, 185, 129, 0.4);
            --accent-blue: #3b82f6;
            --accent-blue-light: #60a5fa;
            --accent-blue-dark: #2563eb;
            --accent-blue-bg: rgba(59, 130, 246, 0.12);
            --accent-blue-glow: rgba(59, 130, 246, 0.4);
            --accent-purple-bg: rgba(139, 92, 246, 0.12);
            --accent-red: #ef4444;
            --accent-red-dark: #dc2626;
            --accent-red-bg: rgba(239, 68, 68, 0.12);
            --accent-red-glow: rgba(239, 68, 68, 0.4);
            --accent-yellow: #f59e0b;
            --accent-yellow-bg: rgba(245, 158, 11, 0.12);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --shadow-glow-blue: 0 0 20px rgba(59,130,246,0.3);
            --shadow-glow-green: 0 0 20px rgba(16,185,129,0.3);
            --shadow-glow-red: 0 0 20px rgba(239,68,68,0.3);
            --shadow-inner: inset 0 2px 4px rgba(0,0,0,0.3);
            --radius: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        html { font-size:16px; -webkit-text-size-adjust:100%; overflow-x:hidden; }
        body { font-family:'Kanit',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; min-height:100dvh; line-height:1.5; overflow-x:hidden; -webkit-font-smoothing:antialiased; width:100%; max-width:100vw; }
        .hidden { display:none !important; }

        /* Loading */
        @keyframes spin { to { transform:rotate(360deg); } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
        .loading-overlay { position:fixed; inset:0; background:linear-gradient(135deg,var(--bg-primary) 0%,var(--bg-secondary) 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        .loader-ring { width:56px; height:56px; border:3px solid var(--border); border-radius:50%; border-top-color:var(--accent-blue); animation:spin 1s ease-in-out infinite; margin-bottom:24px; box-shadow:var(--shadow-glow-blue); }
        .loading-text { font-size:0.95rem; margin-bottom:20px; color:var(--text-secondary); }
        .progress-bar { width:200px; height:4px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--accent-blue),#06b6d4); border-radius:4px; transition:width 0.4s ease; }

        /* Header */
        .att-header { display:flex; justify-content:space-between; align-items:center; padding:16px; position:fixed; top:0; left:0; right:0; z-index:500; background:var(--bg-primary); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border-bottom:1px solid var(--border); }
        @supports (padding-top: env(safe-area-inset-top)) {
            .att-header { padding-top:calc(16px + env(safe-area-inset-top,0px)); }
            .att-container { padding-top:calc(100px + env(safe-area-inset-top,0px)) !important; }
        }
        @media all and (display-mode: standalone) {
            .att-header { padding-top:calc(8px + var(--safe-top)) !important; }
            .att-container { padding-top:calc(90px + var(--safe-top)) !important; }
        }
        html.pwa-standalone .att-header { padding-top:calc(8px + var(--safe-top)) !important; }
        html.pwa-standalone .att-container { padding-top:calc(90px + var(--safe-top)) !important; }
        @media (min-width:601px) {
            .att-container { padding-top:110px !important; }
            html.pwa-standalone .att-container { padding-top:calc(80px + var(--safe-top)) !important; }
        }
        @supports (padding-top: env(safe-area-inset-top)) {
            @media (min-width:601px) {
                .att-container { padding-top:calc(110px + env(safe-area-inset-top,0px)) !important; }
            }
        }
        .att-logo { display:flex; align-items:center; gap:12px; }
        .att-logo .icon { width:46px; height:46px; background:linear-gradient(135deg,var(--accent-blue-bg) 0%,var(--accent-purple-bg) 100%); border-radius:var(--radius-md); display:flex; align-items:center; justify-content:center; border:1px solid var(--border); box-shadow:var(--shadow-sm); }
        .att-logo .icon svg { width:24px; height:24px; color:var(--accent-blue-light); stroke:var(--accent-blue-light); }
        .att-logo h1 { font-size:1.15rem; font-weight:600; background:linear-gradient(135deg,var(--text-primary) 0%,var(--text-secondary) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .lite-badge { font-size:0.6rem; background:var(--accent-green); color:white; padding:2px 8px; border-radius:10px; font-weight:500; letter-spacing:0.5px; margin-left:4px; -webkit-text-fill-color:white; }

        /* Container */
        .att-container { width:100%; max-width:440px; margin:0 auto; padding:0 16px; padding-bottom:calc(24px + var(--safe-bottom)); flex:1; padding-top:100px; min-height:100vh; min-height:100dvh; background:linear-gradient(180deg,var(--bg-secondary) 0%,var(--bg-primary) 50%); }

        /* Main Card */
        .main-card { background:var(--bg-card); border-radius:var(--radius); box-shadow:var(--shadow-lg); overflow:hidden; border:1px solid var(--border); margin-top:16px; animation:slideUp 0.4s ease; }

        /* Time */
        .time-section { padding:28px 24px; text-align:center; background:linear-gradient(180deg,var(--bg-elevated) 0%,var(--bg-card) 100%); border-bottom:1px solid var(--border); }
        .time-display { font-size:clamp(2.8rem,12vw,3.8rem); font-weight:700; color:var(--text-primary); line-height:1; margin-bottom:8px; font-variant-numeric:tabular-nums; text-shadow:0 2px 10px rgba(0,0,0,0.3); }
        .date-display { font-size:0.9rem; color:var(--text-secondary); }

        /* Status */
        .status-section { padding:16px 20px; }
        .status-card { padding:14px 16px; border-radius:var(--radius-sm); display:flex; align-items:center; gap:12px; background:var(--accent-blue-bg); border:1px solid rgba(59,130,246,0.3); transition:all 0.3s ease; }
        .status-card.matched { background:var(--accent-green-bg); border-color:rgba(16,185,129,0.3); box-shadow:var(--shadow-glow-green); }
        .status-card svg { width:22px; height:22px; flex-shrink:0; }
        .status-card:not(.matched) svg { color:var(--accent-blue); stroke:var(--accent-blue); }
        .status-card.matched svg { color:var(--accent-green); stroke:var(--accent-green); }
        .status-card span { font-size:0.9rem; font-weight:500; }

        /* Shift */
        .shift-section { padding:20px; }
        .section-label { font-size:0.85rem; font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px; color:var(--text-secondary); }
        .section-label svg { width:16px; height:16px; stroke:var(--accent-blue); }
        .shift-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
        .shift-btn { padding:14px 8px; border:2px solid var(--border); border-radius:var(--radius-sm); background:var(--bg-tertiary); cursor:pointer; text-align:center; font-family:'Kanit'; transition:all 0.3s ease; box-shadow:var(--shadow-sm); }
        .shift-btn:hover { border-color:var(--accent-blue); background:var(--bg-elevated); transform:translateY(-2px); }
        .shift-btn.active { border-color:var(--accent-green); background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); box-shadow:var(--shadow-glow-green); transform:translateY(-2px); }
        .shift-btn .name { font-weight:600; font-size:0.85rem; color:var(--text-primary); }
        .shift-btn .time { font-size:0.7rem; color:var(--text-secondary); margin-top:2px; }
        .shift-btn.active .name, .shift-btn.active .time { color:white; }

        /* Camera */
        .camera-section { padding:0 20px 20px; }
        .camera-wrapper { position:relative; aspect-ratio:4/3; background:linear-gradient(135deg,#000 0%,#0a0f1a 100%); border-radius:var(--radius-md); overflow:hidden; border:2px solid var(--border); box-shadow:var(--shadow-inner),var(--shadow-md); }
        .camera-wrapper video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
        .camera-wrapper canvas { position:absolute; inset:0; width:100%; height:100%; transform:scaleX(-1); }
        .camera-placeholder { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-muted); background:linear-gradient(135deg,var(--bg-tertiary) 0%,var(--bg-primary) 100%); }
        .camera-placeholder svg { width:48px; height:48px; margin-bottom:12px; opacity:0.5; stroke:var(--text-muted); }

        /* Matched */
        .matched-section { padding:16px 20px; border-top:1px solid var(--border); display:flex; align-items:center; gap:14px; background:linear-gradient(135deg,var(--accent-green-bg) 0%,transparent 100%); animation:fadeIn 0.3s ease; }
        .matched-avatar { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:1.3rem; font-weight:700; box-shadow:var(--shadow-md),var(--shadow-glow-green); flex-shrink:0; }
        .matched-info { flex:1; min-width:0; }
        .matched-info h3 { font-size:1rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .matched-info p { font-size:0.75rem; color:var(--text-secondary); }
        .confidence-badge { text-align:center; padding:8px 14px; background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); border-radius:var(--radius-sm); color:white; box-shadow:var(--shadow-sm); flex-shrink:0; }
        .confidence-badge .value { font-size:1.15rem; font-weight:700; }
        .confidence-badge .label { font-size:0.6rem; opacity:0.9; }

        /* Action Buttons */
        .action-inner { padding:20px; display:flex; flex-direction:column; gap:12px; border-top:1px solid var(--border); background:var(--bg-tertiary); }
        .action-btn { padding:16px; border:none; border-radius:var(--radius-sm); font-family:'Kanit'; font-size:1.05rem; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; color:white; transition:all 0.3s ease; }
        .action-btn svg { width:22px; height:22px; stroke:white; }
        .action-btn.checkin { background:linear-gradient(135deg,var(--accent-green) 0%,var(--accent-green-dark) 100%); box-shadow:var(--shadow-md); }
        .action-btn.checkout { background:linear-gradient(135deg,var(--accent-red) 0%,var(--accent-red-dark) 100%); box-shadow:var(--shadow-md); }
        .action-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .action-btn:hover:not(:disabled) { transform:translateY(-3px); }

        /* GPS Status */
        .gps-status { padding:0 20px 16px; }
        .gps-card { padding:10px 14px; border-radius:var(--radius-sm); display:flex; align-items:center; gap:10px; font-size:0.8rem; color:var(--text-muted); background:var(--bg-tertiary); border:1px solid var(--border); }
        .gps-card svg { width:16px; height:16px; flex-shrink:0; }
        .gps-card.ok { color:var(--accent-green); border-color:rgba(16,185,129,0.3); background:var(--accent-green-bg); }
        .gps-card.ok svg { stroke:var(--accent-green); }
        .gps-card.err { color:var(--accent-red); border-color:rgba(239,68,68,0.3); background:var(--accent-red-bg); }
        .gps-card.err svg { stroke:var(--accent-red); }
        .gps-card.wait svg { stroke:var(--text-muted); }

        /* Modal */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; visibility:hidden; transition:all 0.3s ease; padding:16px; }
        .modal-overlay.active { opacity:1; visibility:visible; }
        .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:28px; max-width:380px; width:100%; transform:scale(0.9) translateY(20px); transition:all 0.3s ease; box-shadow:0 16px 48px rgba(0,0,0,0.6); }
        .modal-overlay.active .modal { transform:scale(1) translateY(0); }
        .modal-icon { width:72px; height:72px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; animation:scaleIn 0.3s ease 0.1s both; }
        .modal-icon.success { background:var(--accent-green-bg); color:var(--accent-green); box-shadow:var(--shadow-glow-green); }
        .modal-icon.error { background:var(--accent-red-bg); color:var(--accent-red); box-shadow:var(--shadow-glow-red); }
        .modal-icon.warning { background:var(--accent-yellow-bg); color:var(--accent-yellow); }
        .modal-icon svg { width:36px; height:36px; }
        .modal-icon.success svg { stroke:var(--accent-green); }
        .modal-icon.error svg { stroke:var(--accent-red); }
        .modal-icon.warning svg { stroke:var(--accent-yellow); }
        .modal-title { font-size:1.25rem; font-weight:600; text-align:center; margin-bottom:10px; }
        .modal-message { text-align:center; color:var(--text-secondary); margin-bottom:24px; line-height:1.6; white-space:pre-line; font-size:0.9rem; }
        .btn-ok { width:100%; padding:14px; border:none; border-radius:var(--radius-sm); font-family:'Kanit'; font-size:1rem; font-weight:600; cursor:pointer; background:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-blue-dark) 100%); color:white; box-shadow:var(--shadow-sm); transition:all 0.3s ease; }
        .btn-ok:hover { transform:translateY(-2px); box-shadow:var(--shadow-md),var(--shadow-glow-blue); }

        /* Spinner */
        .spinner { animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }

        @media (max-width:480px) { html { font-size:15px; } .att-container { padding:0 12px; padding-bottom:calc(20px + var(--safe-bottom)); padding-top:100px; } }
        @media (max-width:360px) { html { font-size:14px; } .shift-grid { grid-template-columns:1fr; gap:8px; } }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader-ring"></div>
        <div class="loading-text" id="loadingText">กำลังโหลด...</div>
        <div class="progress-bar"><div class="progress-fill" id="loadingProgress" style="width:0%"></div></div>
    </div>

    <!-- SVG Icons (inline to avoid Lucide dependency) -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <symbol id="ico-scan-face" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></symbol>
        <symbol id="ico-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
        <symbol id="ico-log-in" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></symbol>
        <symbol id="ico-log-out" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></symbol>
        <symbol id="ico-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></symbol>
        <symbol id="ico-camera-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><path d="M7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16"/><path d="M14.5 4h-5L7 7"/><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/></symbol>
        <symbol id="ico-smile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></symbol>
        <symbol id="ico-map-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></symbol>
        <symbol id="ico-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></symbol>
        <symbol id="ico-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></symbol>
        <symbol id="ico-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></symbol>
        <symbol id="ico-loader" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></symbol>
    </svg>

    <!-- Main Page -->
    <header class="att-header">
        <div class="att-logo">
            <div class="icon"><svg width="24" height="24"><use href="#ico-scan-face"/></svg></div>
            <h1>ลงเวลาทำงาน <span class="lite-badge">LITE</span></h1>
        </div>
    </header>
    <div class="att-container">
        <div class="main-card">
            <div class="time-section">
                <div class="time-display" id="currentTime">00:00:00</div>
                <div class="date-display" id="currentDate">-</div>
            </div>
            <div class="status-section">
                <div class="status-card" id="faceStatus">
                    <svg width="22" height="22"><use href="#ico-scan-face"/></svg>
                    <span>รอตรวจจับใบหน้า</span>
                </div>
            </div>
            <div class="shift-section">
                <div class="section-label"><svg width="16" height="16"><use href="#ico-clock"/></svg><span>เลือกผลัดการทำงาน</span></div>
                <div class="shift-grid">
                    <button class="shift-btn" data-shift="morning"><div class="name">ผลัดเช้า</div><div class="time">06:00-14:00</div></button>
                    <button class="shift-btn" data-shift="afternoon"><div class="name">ผลัดบ่าย</div><div class="time">14:00-22:00</div></button>
                    <button class="shift-btn" data-shift="daywork"><div class="name">Daywork</div><div class="time">08:30-16:30</div></button>
                </div>
            </div>
            <div class="camera-section">
                <div class="camera-wrapper">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="overlayCanvas"></canvas>
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        <svg width="48" height="48"><use href="#ico-camera"/></svg>
                        <p>กำลังเปิดกล้อง...</p>
                    </div>
                </div>
            </div>
            <div class="gps-status">
                <div class="gps-card wait" id="gpsStatus">
                    <svg width="16" height="16"><use href="#ico-map-pin"/></svg>
                    <span>กำลังตรวจสอบ GPS...</span>
                </div>
            </div>
            <div class="matched-section hidden" id="matchedSection">
                <div class="matched-avatar" id="matchedAvatar">-</div>
                <div class="matched-info"><h3 id="matchedName">-</h3><p id="matchedPosition">-</p></div>
                <div class="confidence-badge"><div class="value" id="matchConfidence">0%</div><div class="label">ความแม่นยำ</div></div>
            </div>
            <div class="action-inner">
                <button class="action-btn checkin" id="btnCheckIn" disabled>
                    <svg width="22" height="22"><use href="#ico-log-in"/></svg><span>เข้างาน</span>
                </button>
                <button class="action-btn checkout" id="btnCheckOut" disabled>
                    <svg width="22" height="22"><use href="#ico-log-out"/></svg><span>ออกงาน</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div class="modal-icon" id="resultIcon"><svg width="36" height="36"><use href="#ico-check"/></svg></div>
            <h3 class="modal-title" id="resultTitle">สำเร็จ</h3>
            <p class="modal-message" id="resultMessage">-</p>
            <button class="btn-ok" onclick="closeResultModal()">ตกลง</button>
        </div>
    </div>

    <canvas id="captureCanvas" style="display:none"></canvas>

    <script>
    const API_URL='https://script.google.com/macros/s/AKfycbxbpxSx3l-ZsSNm62pw9qcxfeqVxZnKSY3Shu5AgL3Yr2WZfMIEO3rQjFCQB23yIQOY/exec';
    const API_KEY='ATT-2024-xK9mP3nQ7vL2wR5y';
    const FIREBASE_URL='https://employee-attendance-89b36-default-rtdb.asia-southeast1.firebasedatabase.app';
    const FACE_MATCH_THRESHOLD=0.5;
    const WORK_AREAS=[[{lat:17.3861111,lng:102.7766667},{lat:17.3869444,lng:102.7744444},{lat:17.3875000,lng:102.7747222},{lat:17.3865411,lng:102.7769119}],[{lat:17.3844444,lng:102.7794444},{lat:17.3844444,lng:102.7791667},{lat:17.3850000,lng:102.7794444},{lat:17.3850000,lng:102.7797222}]];

    let currentLocation=null, videoStream=null, employees=[];
    let matchedEmployee=null, faceDescriptor=null, isDetecting=false, detectionInterval=null, selectedShift=null;

    const spinnerHTML='<svg class="spinner" width="18" height="18"><use href="#ico-loader"/></svg>';

    // === Firebase ===
    async function firebaseGet(path){try{const r=await fetch(FIREBASE_URL+'/'+path+'.json');return r.json();}catch(e){return null;}}
    async function firebasePush(path,data){try{const r=await fetch(FIREBASE_URL+'/'+path+'.json',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});return r.json();}catch(e){return null;}}

    // === API ===
    async function callAPI(data){data.apiKey=API_KEY;data.origin=window.location.origin;const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(data)});return r.json();}

    // === Init ===
    document.addEventListener('DOMContentLoaded',async()=>{
        if(window.navigator.standalone===true||(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)){
            document.documentElement.classList.add('pwa-standalone');
        }
        updateDateTime();
        setInterval(updateDateTime,1000);
        setupShiftButtons();
        setupActionButtons();
        requestGPS();
        await loadFaceAPI();
        await loadEmployees();
        await startCamera();
        startDetection();
    });

    // === GPS ===
    function requestGPS(){
        if(!navigator.geolocation){updateGPSStatus('err','GPS ไม่รองรับ');return;}
        updateGPSStatus('wait','กำลังตรวจสอบ GPS...');
        navigator.geolocation.getCurrentPosition(pos=>{
            currentLocation={latitude:pos.coords.latitude,longitude:pos.coords.longitude};
            const area=isInAnyWorkArea(currentLocation.latitude,currentLocation.longitude);
            if(area.valid){updateGPSStatus('ok','อยู่ในพื้นที่ทำงาน (โซน '+area.area+')');}
            else{updateGPSStatus('err','อยู่นอกพื้นที่ทำงาน');}
        },err=>{updateGPSStatus('err','ไม่สามารถระบุตำแหน่งได้');},{enableHighAccuracy:true,timeout:15000});
    }
    function refreshGPS(){return new Promise((resolve,reject)=>{if(!navigator.geolocation){reject('ไม่รองรับ GPS');return;}navigator.geolocation.getCurrentPosition(pos=>{currentLocation={latitude:pos.coords.latitude,longitude:pos.coords.longitude};resolve(currentLocation);},err=>reject('ไม่สามารถระบุพิกัดได้'),{enableHighAccuracy:true,timeout:10000,maximumAge:0});});}
    function updateGPSStatus(type,msg){
        const el=document.getElementById('gpsStatus');
        el.className='gps-card '+type;
        el.innerHTML='<svg width="16" height="16"><use href="#ico-map-pin"/></svg><span>'+msg+'</span>';
    }
    function isPointInPolygon(lat,lng,poly){let inside=false;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const xi=poly[i].lat,yi=poly[i].lng,xj=poly[j].lat,yj=poly[j].lng;if(((yi>lng)!==(yj>lng))&&(lat<(xj-xi)*(lng-yi)/(yj-yi)+xi))inside=!inside;}return inside;}
    function isInAnyWorkArea(lat,lng){for(let i=0;i<WORK_AREAS.length;i++)if(isPointInPolygon(lat,lng,WORK_AREAS[i]))return{valid:true,area:i+1};return{valid:false,area:-1};}

    // === Setup ===
    function setupShiftButtons(){
        document.querySelectorAll('.shift-btn').forEach(b=>{
            b.addEventListener('click',()=>{
                document.querySelectorAll('.shift-btn').forEach(x=>x.classList.remove('active'));
                b.classList.add('active');
                selectedShift=b.dataset.shift;
                checkBtns();
            });
        });
    }
    function setupActionButtons(){
        document.getElementById('btnCheckIn').addEventListener('click',()=>recordAtt('checkIn'));
        document.getElementById('btnCheckOut').addEventListener('click',()=>recordAtt('checkOut'));
    }

    // === Face API ===
    async function loadFaceAPI(){
        const URL='https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
        try{
            setText('โหลด Face Detection...');setProgress('25%');
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            setText('โหลด Landmarks...');setProgress('50%');
            await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
            setText('โหลด Recognition...');setProgress('75%');
            await faceapi.nets.faceRecognitionNet.loadFromUri(URL);
            setText('พร้อมใช้งาน!');setProgress('100%');
            setTimeout(()=>document.getElementById('loadingOverlay').classList.add('hidden'),400);
        }catch(e){setText('โหลดไม่สำเร็จ กรุณารีเฟรช');}
    }
    function setText(t){document.getElementById('loadingText').textContent=t;}
    function setProgress(w){document.getElementById('loadingProgress').style.width=w;}

    // === Load Employees ===
    async function loadEmployees(){
        try{
            const r=await callAPI({action:'getEmployeesWithFace'});
            if(r.status==='success'){
                let allEmps=r.data;
                const faceData=await firebaseGet('faceData');
                if(faceData){
                    allEmps.forEach(emp=>{
                        if(faceData[emp.id]){emp.faceDescriptor=faceData[emp.id].descriptor;emp.hasFaceData=true;}
                    });
                }
                employees=allEmps.filter(e=>e.hasFaceData);
            }
        }catch(e){console.error('Load employees error:',e);}
    }

    // === Camera ===
    async function startCamera(){
        try{
            videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}});
            const v=document.getElementById('video');
            v.srcObject=videoStream;
            v.onloadedmetadata=()=>{
                v.play();
                document.getElementById('cameraPlaceholder').style.display='none';
                const cv=document.getElementById('overlayCanvas');
                cv.width=v.videoWidth;cv.height=v.videoHeight;
            };
        }catch(e){
            document.getElementById('cameraPlaceholder').innerHTML='<svg width="48" height="48"><use href="#ico-camera-off"/></svg><p>เปิดกล้องไม่ได้</p>';
        }
    }
    function capturePhoto(v){const c=document.getElementById('captureCanvas'),ctx=c.getContext('2d');c.width=v.videoWidth;c.height=v.videoHeight;ctx.translate(c.width,0);ctx.scale(-1,1);ctx.drawImage(v,0,0);return c.toDataURL('image/jpeg',0.8);}

    // === Detection ===
    function startDetection(){
        if(detectionInterval)clearInterval(detectionInterval);
        detectionInterval=setInterval(async()=>{
            if(isDetecting)return;
            const v=document.getElementById('video');
            if(!v||v.paused||v.ended)return;
            isDetecting=true;
            await detectFace();
            isDetecting=false;
        },300);
    }

    function getFirstNameChar(fullName,title){
        let name=fullName||'';
        if(title&&name.startsWith(title))name=name.substring(title.length).trim();
        return name.charAt(0).toUpperCase()||'?';
    }

    async function detectFace(){
        const v=document.getElementById('video'),c=document.getElementById('overlayCanvas');
        try{
            const d=await faceapi.detectSingleFace(v,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            const ctx=c.getContext('2d');
            ctx.clearRect(0,0,c.width,c.height);
            if(!d){
                updateFaceStatus('scan','กำลังค้นหาใบหน้า...');
                matchedEmployee=null;faceDescriptor=null;
                document.getElementById('matchedSection').classList.add('hidden');
                checkBtns();return;
            }
            faceDescriptor=d.descriptor;
            const box=d.detection.box,sx=c.width/v.videoWidth,sy=c.height/v.videoHeight;
            let best=null,bestD=1;
            for(const e of employees){
                if(!e.faceDescriptor)continue;
                const dist=faceapi.euclideanDistance(d.descriptor,new Float32Array(e.faceDescriptor));
                if(dist<bestD&&dist<FACE_MATCH_THRESHOLD){bestD=dist;best=e;}
            }
            ctx.strokeStyle=best?'#10b981':'#ef4444';
            ctx.lineWidth=4;
            ctx.strokeRect(box.x*sx,box.y*sy,box.width*sx,box.height*sy);
            if(best){
                matchedEmployee=best;
                matchedEmployee.faceDistance=bestD;
                const conf=((1-bestD)*100).toFixed(1);
                const avatarChar=getFirstNameChar(best.name,best.title);
                updateFaceStatus('matched',best.fullName||best.name);
                const ms=document.getElementById('matchedSection');ms.classList.remove('hidden');
                document.getElementById('matchedName').textContent=best.fullName||best.name;
                document.getElementById('matchedPosition').textContent=best.id+' | '+(best.position||'-');
                document.getElementById('matchConfidence').textContent=conf+'%';
                document.getElementById('matchedAvatar').textContent=avatarChar;
            }else{
                matchedEmployee=null;
                updateFaceStatus('scan','ไม่พบข้อมูลใบหน้า');
                document.getElementById('matchedSection').classList.add('hidden');
            }
            checkBtns();
        }catch(e){}
    }

    function updateFaceStatus(s,m){
        const el=document.getElementById('faceStatus');
        const isMatch=s==='matched';
        el.className='status-card '+(isMatch?'matched':'');
        el.innerHTML='<svg width="22" height="22"><use href="#'+(isMatch?'ico-smile':'ico-scan-face')+'"/></svg><span>'+m+'</span>';
    }
    function checkBtns(){
        const ok=matchedEmployee&&selectedShift;
        document.getElementById('btnCheckIn').disabled=!ok;
        document.getElementById('btnCheckOut').disabled=!ok;
    }

    // === Record Attendance ===
    async function recordAtt(action){
        if(!matchedEmployee||!selectedShift)return;
        const btn=document.getElementById(action==='checkIn'?'btnCheckIn':'btnCheckOut');
        const orig=btn.innerHTML;
        btn.innerHTML=spinnerHTML+' กำลังตรวจสอบ...';btn.disabled=true;

        // Fresh GPS
        try{await refreshGPS();}catch(e){
            showResult('error','ไม่พบ GPS','กรุณาเปิด GPS และอนุญาตให้ใช้ตำแหน่ง');
            btn.innerHTML=orig;btn.disabled=false;checkBtns();return;
        }
        const area=isInAnyWorkArea(currentLocation.latitude,currentLocation.longitude);
        updateGPSStatus(area.valid?'ok':'err',area.valid?'อยู่ในพื้นที่ทำงาน (โซน '+area.area+')':'อยู่นอกพื้นที่ทำงาน');
        if(!area.valid){
            showResult('error','นอกพื้นที่ทำงาน','คุณอยู่นอกพื้นที่ที่กำหนด\n\nพิกัด: '+currentLocation.latitude.toFixed(6)+', '+currentLocation.longitude.toFixed(6));
            btn.innerHTML=orig;btn.disabled=false;checkBtns();return;
        }

        btn.innerHTML=spinnerHTML+' บันทึก...';
        try{
            const photo=capturePhoto(document.getElementById('video'));
            const now=new Date();
            const timeStr=now.toLocaleTimeString('th-TH',{hour12:false});
            const t=action==='checkIn'?'เข้างาน':'ออกงาน';

            // Save to Firebase first (offline-first)
            const attData={visitorId:matchedEmployee.id,type:t,shift:selectedShift,time:timeStr,area:area.area,timestamp:now.toISOString()};
            const fbResult=await firebasePush('pendingAttendance',attData);

            showResult('success','บันทึก'+t+'สำเร็จ',
                (matchedEmployee.fullName||matchedEmployee.name)+
                '\nผลัด: '+getShiftName(selectedShift)+
                '\nเวลา: '+timeStr+
                '\nพื้นที่: โซน '+area.area);

            // Sync to Google Sheets in background
            callAPI({
                action:action,
                employeeId:matchedEmployee.id,
                employeeName:matchedEmployee.fullName||matchedEmployee.name,
                latitude:currentLocation.latitude,
                longitude:currentLocation.longitude,
                faceVerified:true,
                faceConfidence:1-matchedEmployee.faceDistance,
                shift:selectedShift,
                photoBase64:photo
            }).then(r=>{
                if(r.status==='success'&&fbResult&&fbResult.name)
                    callAPI({action:'deletePendingAttendance',key:fbResult.name});
            }).catch(e=>console.error('Sync failed:',e));
        }catch(e){
            showResult('error','เกิดข้อผิดพลาด','เชื่อมต่อเซิร์ฟเวอร์ไม่ได้');
        }finally{
            btn.innerHTML=orig;btn.disabled=false;checkBtns();
        }
    }

    function getShiftName(s){
        if(s==='morning')return'ผลัดเช้า (06:00-14:00)';
        if(s==='afternoon')return'ผลัดบ่าย (14:00-22:00)';
        if(s==='daywork')return'Daywork (08:30-16:30)';
        return s;
    }

    // === Time ===
    function updateDateTime(){
        const n=new Date();
        document.getElementById('currentTime').textContent=n.toLocaleTimeString('th-TH',{hour12:false});
        document.getElementById('currentDate').textContent=n.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    }

    // === Modal ===
    function showResult(type,title,msg){
        const m=document.getElementById('resultModal'),icon=document.getElementById('resultIcon');
        icon.className='modal-icon '+type;
        const icoName=type==='success'?'ico-check':type==='error'?'ico-x':'ico-alert';
        icon.innerHTML='<svg width="36" height="36"><use href="#'+icoName+'"/></svg>';
        document.getElementById('resultTitle').textContent=title;
        document.getElementById('resultMessage').textContent=msg;
        m.classList.add('active');
    }
    function closeResultModal(){document.getElementById('resultModal').classList.remove('active');}
    document.getElementById('resultModal').addEventListener('click',e=>{if(e.target.id==='resultModal')closeResultModal();});
    </script>
</body>
</html>
